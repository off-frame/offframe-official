---
// offframe告知専用オーバーレイ
// BaseLayoutに1つ置くだけ
// 開き方: window.openPromoOverlay() を呼ぶ
---

<div id="promoOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:9999; align-items:center; justify-content:center;">
  <div class="po-inner">

    <div class="po-images">
      <div class="po-img-wrap">
        <img src="/images/low/1602.webp" alt="standard" />
        <span class="po-label">通常表示</span>
      </div>
      <div class="po-arrow">→</div>
      <div class="po-img-wrap">
        <img src="/images/full_low/1602.webp" alt="off frame" />
        <span class="po-label">オフフレームモード</span>
      </div>
    </div>

    <div class="po-text">
      <div class="po-copy">
        <p class="po-sub">枠を外し、写真の外側に広がる世界へ。</p>
        <h2 class="po-title">OFF FRAME MODE</h2>
        <p class="po-hint po-hint-pc" id="poHintPc">ボタンを押すとサイトの画像が切り替わります。<br>サイドメニューからいつでも切り替えが可能です。</p>
      </div>
      <div class="po-btns">
        <p class="po-note-btns" id="promoNoteBtns" style="display:none;">オフフレームモードは、<br>ログインするとご使用いただけます。</p>
        <button class="po-btn" id="overlayOffframeBtn" onclick="window.handleOverlayStandard()">Standard</button>
        <button class="po-btn po-btn-premium" id="overlayPremiumBtn" onclick="window.handleOverlayPremium()">Premium</button>
        <button class="po-btn po-btn-register" id="overlayRegisterBtn" style="display:none;" onclick="window.openAuthModal?.()">会員登録 / ログイン</button>
        <p class="po-hint po-hint-sp" id="poHintSp">ボタンを押すとサイトの画像が切り替わります。<br>サイドメニューからいつでも切り替えが可能です。</p>
      </div>
    </div>
    <button class="po-close-mobile" onclick="window.closePromoOverlay()">閉じる</button>
  </div>
</div>

<style>
  .po-inner {
    background: #000;
    border: 1px solid #888888;
    width: min(900px, 82vw);
    position: relative;
    padding: 2rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .po-images {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 1rem;
  }

  .po-img-wrap {
    flex: 1;
    position: relative;
  }

  .po-img-wrap img {
    width: 100%;
    height: auto;
    display: block;
  }

  .po-label {
    position: absolute;
    top: 1rem;
    left: 0.5rem;
    font-family: "Shippori Mincho", serif;
    font-weight: 300;
    font-size: 0.9rem;
    letter-spacing: 0.15em;
    color: #fff;
    background: rgba(0,0,0,0.5);
    padding: 0.1rem 0.35rem;
  }

  .po-arrow {
    font-family: "Cormorant Garamond", serif;
    font-size: 1.8rem;
    color: #686868;
    flex-shrink: 0;
  }

  .po-text {
    display: flex;
    flex-direction: row;
    align-items: flex-start;
    gap: 2rem;
    padding-left: 0.5rem;
  }

  .po-copy {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
    flex: 1;
  }

  .po-title {
    font-family: "Cormorant Garamond", serif;
    font-weight: 300;
    font-size: 2.2rem;
    letter-spacing: 0.3em;
    color: #fff;
    margin: 0;
  }

  .po-sub {
    font-family: "Shippori Mincho", serif;
    font-size: 0.95rem;
    line-height: 1.6;
    letter-spacing: 0.35em;
    color: #fff;
    margin: 0 0 0.2rem;
  }

  .po-note {
    font-family: "Shippori Mincho", serif;
    font-size: 0.8rem;
    line-height: 1.9;
    letter-spacing: 0.06em;
    color: #a0a0a0;
    margin: 0;
    flex: 1;
  }

  .po-note-guest {
    font-size: 0.95rem;
    line-height: 2.2;
    letter-spacing: 0.1em;
    color: #ccc;
  }

  .po-btn {
    font-family: "Cormorant Garamond", serif;
    font-weight: 300;
    font-size: 0.85rem;
    letter-spacing: 0.2em;
    background: #fff;
    border: none;
    color: #000;
    padding: 0.5rem 1.5rem;
    cursor: pointer;
    border-radius: 0;
    transition: opacity 0.25s ease;
    flex-shrink: 0;
    white-space: nowrap;
  }

  .po-btn:hover { opacity: 0.75; }

  .po-btns {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    flex-shrink: 0;
  }

  .po-btn-premium {
    background: #dbc06c !important;
    color: #000 !important;
    border-radius: 100px;
    text-decoration: none;
    text-align: center;
    font-size: 1.1rem !important;
    padding: 0.8rem 2.5rem !important;
    letter-spacing: 0.25em !important;
  }

  .po-note-btns {
    font-family: "Shippori Mincho", serif;
    font-size: 0.75rem;
    line-height: 1.9;
    letter-spacing: 0.06em;
    color: #ccc;
    margin: 0 0 0.2rem;
    text-align: left;
  }

  .po-btn-register {
    background: #fff;
    color: #000;
    border-radius: 0;
    font-size: 1.1rem;
    padding: 0.8rem 2.5rem;
    letter-spacing: 0.25em;
  }

  #overlayOffframeBtn {
    background: #2a2a2a;
    border: 1px solid #444;
    color: #8f8f8f;
    border-radius: 100px;
    font-size: 1.1rem;
    padding: 0.8rem 2.5rem;
    letter-spacing: 0.25em;
  }

  #overlayOffframeBtn:hover {
    border-color: #666;
    color: #999;
  }

  #overlayOffframeBtn.active {
    background: #fff;
    border-color: #fff;
    color: #000;
    box-shadow: 0 0 12px rgba(255, 255, 255, 0.6), 0 0 24px rgba(255, 255, 255, 0.2);
  }

  .po-hint {
    font-family: "Shippori Mincho", serif;
    font-size: 0.75rem;
    line-height: 1.9;
    letter-spacing: 0.05em;
    color: #666;
    margin: 0.3rem 0 0;
  }

  .po-hint-pc {
    text-align: left;
  }

  .po-hint-sp {
    display: none;
  }

  .po-close-mobile {
    display: none;
  }

  .po-btn.active {
    background: #fff;
    border-color: #fff;
    color: #000;
    box-shadow: 0 0 12px rgba(255,255,255,0.6), 0 0 24px rgba(255,255,255,0.2);
  }

  @media (max-width: 950px) {
    .po-sub { font-size: 0.75rem; }
  }

  @media (max-width: 840px) {
    .po-inner { padding: 1.2rem 0.8rem; gap: 1rem; width: 95vw; }
    .po-images { gap: 0.5rem; }
    .po-arrow { font-size: 0.9rem; color: #a0a0a0; flex-shrink: 0; }
    .po-label { top: 0.4rem; left: 0; font-size: 0.7rem; letter-spacing: 0.08em; white-space: nowrap; }
    .po-text {
      flex-direction: column;
      align-items: center;
      gap: 0.75rem;
      text-align: center;
    }
    .po-copy { order: 1; align-items: center; }
    .po-title { white-space: normal; margin-left: 0; font-size: 1.4rem; }
    .po-sub { margin-left: 0; font-size: 0.65rem; }
    .po-note { text-align: center; font-size: 0.7rem; line-height: 1.7; }
    .po-note-guest { font-size: 0.75rem !important; line-height: 1.8 !important; }
    .po-btns { order: 2; }
    .po-btns { width: 80%; align-self: center; }
    .po-btns .po-btn,
    .po-btns #overlayOffframeBtn,
    .po-btns .po-btn-premium { width: 100%; padding: 1rem 0 !important; font-size: 1.05rem !important; box-sizing: border-box; border: 1px solid transparent; }
    .po-btns #overlayOffframeBtn { border-color: #444; }
    .po-btns .po-btn-premium { border-color: #dbc06c; }
    .po-hint-pc { display: none; }
    .po-hint-sp { display: block; text-align: center; font-size: 0.65rem; }
    .po-note-btns { text-align: center; }
    .po-close-mobile {
      display: block;
      background: transparent;
      border: none;
      font-family: "Shippori Mincho", serif;
      font-size: 0.75rem;
      letter-spacing: 0.15em;
      color: #fff;
      opacity: 0.5;
      cursor: pointer;
      padding: 0.5rem 0 0;
      transition: opacity 0.2s;
    }
    .po-close-mobile:hover { opacity: 1; }
  }

  @media (min-width: 480px) and (max-width: 840px) {
    .po-inner { width: 90vw; padding: 1.5rem; }
    .po-title { font-size: 1.6rem; }
    .po-sub { font-size: 0.75rem; }
    .po-note { font-size: 0.8rem; }
    .po-note-guest { font-size: 0.85rem !important; }
    .po-hint-sp { font-size: 0.7rem; }
    .po-label { font-size: 0.8rem; }
    .po-btns .po-btn,
    .po-btns #overlayOffframeBtn,
    .po-btns .po-btn-premium { font-size: 1.1rem !important; }
  }
</style>

<script is:inline>
  window.openPromoOverlay = function() {
    var el = document.getElementById("promoOverlay");
    if (!el) return;
    el.style.display = "flex";
    document.body.style.overflow = "hidden";

    // ログイン状態チェック
    var sbKey = Object.keys(localStorage).find(function(k) { return k.startsWith("sb-") && k.endsWith("-auth-token"); });
    var isLoggedIn = sbKey ? !!localStorage.getItem(sbKey) : false;

    var offBtn = document.getElementById("overlayOffframeBtn");
    var premBtn = document.getElementById("overlayPremiumBtn");
    var regBtn = document.getElementById("overlayRegisterBtn");
    var noteBtns = document.getElementById("promoNoteBtns");
    var isPremium = localStorage.getItem("offframe_premium") === "1";

    var hintPc = document.getElementById("poHintPc");
    var hintSp = document.getElementById("poHintSp");

    if (isLoggedIn) {
      if (noteBtns) { noteBtns.style.display = "none"; }
      if (regBtn) { regBtn.style.display = "none"; }
      if (hintPc) { hintPc.style.display = ""; }
      if (hintSp) { hintSp.style.display = ""; }
      if (isPremium) {
        if (offBtn) { offBtn.style.display = "none"; }
        if (premBtn) {
          premBtn.style.display = "";
          var isActive = localStorage.getItem("offframe") === "1";
          premBtn.classList.toggle("active", isActive);
        }
      } else {
        if (offBtn) {
          offBtn.style.display = "";
          var isActive = localStorage.getItem("offframe") === "1";
          offBtn.classList.toggle("active", isActive);
        }
        if (premBtn) { premBtn.style.display = ""; }
      }
    } else {
      if (offBtn) { offBtn.style.display = "none"; }
      if (premBtn) { premBtn.style.display = "none"; }
      if (noteBtns) { noteBtns.style.display = ""; }
      if (regBtn) { regBtn.style.display = ""; }
      if (hintPc) { hintPc.style.display = "none"; }
      if (hintSp) { hintSp.style.display = "none"; }
    }
  };

  function isUserLoggedIn() {
    var sbKey = Object.keys(localStorage).find(function(k) { return k.startsWith("sb-") && k.endsWith("-auth-token"); });
    return sbKey ? !!localStorage.getItem(sbKey) : false;
  }

  window.handleOverlayStandard = function() {
    if (!isUserLoggedIn()) {
      window.openAuthModal?.();
      return;
    }
    window.toggleOverlayOffframe("standard");
  };

  window.handleOverlayPremium = function() {
    if (!isUserLoggedIn()) {
      window.openAuthModal?.();
      return;
    }
    if (localStorage.getItem("offframe_premium") === "1") {
      // プレミアム: OFFフレーム切替（全画像）
      window.toggleOverlayOffframe("all");
    } else {
      window.openPremiumModal?.();
    }
  };

  window.closePromoOverlay = function() {
    var el = document.getElementById("promoOverlay");
    if (!el) return;
    el.style.display = "none";
    document.body.style.overflow = "";
  };

  window.toggleOverlayOffframe = function(scope) {
    var next = localStorage.getItem("offframe") === "1" ? "0" : "1";
    localStorage.setItem("offframe", next);
    var active = next === "1";

    // オーバーレイ内ボタン
    var btn = document.getElementById("overlayOffframeBtn");
    if (btn) {
      btn.classList.toggle("active", active);
      btn.textContent = "Standard";
    }

    // サイドナビのボタンも同期
    ["offframeBtn", "drawerOffframeBtn"].forEach(function(id) {
      var b = document.getElementById(id);
      if (b) {
        b.classList.toggle("active", active);
        b.textContent = "Standard";
      }
    });

    // モバイル記事下ボタンも同期
    var mobilePremBtn = document.getElementById("mobilePremiumBtn");
    if (mobilePremBtn) mobilePremBtn.classList.toggle("active", active);
    var mobileStdBtn = document.getElementById("mobileStandardBtn");
    if (mobileStdBtn) mobileStdBtn.classList.toggle("active", active);

    // 画像切替
    var selector = scope === "all" ? "img.switchable" : 'img.switchable[data-tier="standard"]';
    var imgs = document.querySelectorAll(selector);
    imgs.forEach(function(img) { img.classList.add("blurring"); });
    setTimeout(function() {
      imgs.forEach(function(img) {
        img.src = active ? img.dataset.full : img.dataset.general;
      });
      setTimeout(function() {
        imgs.forEach(function(img) { img.classList.remove("blurring"); });
      }, 100);
    }, 300);
  };

  // 背景クリックで閉じる
  document.addEventListener("click", function(e) {
    if (e.target && e.target.id === "promoOverlay") {
      window.closePromoOverlay();
    }
  });

  // ESCで閉じる
  document.addEventListener("keydown", function(e) {
    if (e.key === "Escape") window.closePromoOverlay();
  });

  // ログイン完了で閉じる
  document.addEventListener("offframe:loggedin", function() {
    window.closePromoOverlay();
  });
</script>