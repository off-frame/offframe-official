---
// offframe告知専用オーバーレイ
// BaseLayoutに1つ置くだけ
// 開き方: window.openPromoOverlay() を呼ぶ
---

<div id="promoOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:9999; align-items:center; justify-content:center;">
  <div class="po-inner">

    <div class="po-images">
      <div class="po-img-wrap">
        <img src="/images/low/1602.webp" alt="standard" />
        <span class="po-label">Standard</span>
      </div>
      <div class="po-arrow">→</div>
      <div class="po-img-wrap">
        <img src="/images/full_low/1602.webp" alt="off frame" />
        <span class="po-label">Off Frame</span>
      </div>
    </div>

    <div class="po-text">
      <p class="po-catch">枠を外し、<br>写真の外側に<br>広がる世界へ。</p>
      <p class="po-note" id="promoNoteLoggedIn" style="display:none;">OFFフレームモードは、<br>サイドメニューのボタンから<br>いつでも切り替えられます。</p>
      <p class="po-note po-note-guest" id="promoNoteGuest">OFFフレームモードは、<br>ログインするとご使用いただけます。</p>
      <div class="po-btns">
        <button class="po-btn" id="overlayOffframeBtn" onclick="window.handleOverlayStandard()">Standard</button>
        <button class="po-btn po-btn-premium" id="overlayPremiumBtn" onclick="window.handleOverlayPremium()">Premium</button>
      </div>
    </div>
    <button class="po-close-mobile" onclick="window.closePromoOverlay()">閉じる</button>
  </div>
</div>

<style>
  .po-inner {
    background: #000;
    border: 1px solid #888888;
    width: min(900px, 82vw);
    position: relative;
    padding: 2rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .po-images {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 1rem;
  }

  .po-img-wrap {
    flex: 1;
    position: relative;
  }

  .po-img-wrap img {
    width: 100%;
    height: auto;
    display: block;
  }

  .po-label {
    position: absolute;
    top: 1rem;
    left: 0.5rem;
    font-family: "Cormorant Garamond", serif;
    font-weight: 300;
    font-size: 1.2rem;
    letter-spacing: 0.2em;
    color: #fff;
    background: rgba(0,0,0,0.5);
    padding: 0.1rem 0.4rem;
  }

  .po-arrow {
    font-family: "Cormorant Garamond", serif;
    font-size: 1.8rem;
    color: #686868;
    flex-shrink: 0;
  }

  .po-text {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 2rem;
  }

  .po-catch {
    font-family: "Shippori Mincho", serif;
    font-size: 1.2rem;
    line-height: 2.3rem;
    letter-spacing: 0.3em;
    color: #fff;
    margin: 0;
    white-space: nowrap;
    margin-left: 2rem;
    margin-bottom: 0.3rem;
  }

  .po-note {
    font-family: "Shippori Mincho", serif;
    font-size: 0.8rem;
    line-height: 1.9;
    letter-spacing: 0.06em;
    color: #a0a0a0;
    margin: 0;
    flex: 1;
  }

  .po-note-guest {
    font-size: 0.95rem;
    line-height: 2.2;
    letter-spacing: 0.1em;
    color: #ccc;
  }

  .po-btn {
    font-family: "Cormorant Garamond", serif;
    font-weight: 300;
    font-size: 0.85rem;
    letter-spacing: 0.2em;
    background: #fff;
    border: none;
    color: #000;
    padding: 0.5rem 1.5rem;
    cursor: pointer;
    border-radius: 0;
    transition: opacity 0.25s ease;
    flex-shrink: 0;
    white-space: nowrap;
  }

  .po-btn:hover { opacity: 0.75; }

  .po-btns {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    flex-shrink: 0;
  }

  .po-btn-premium {
    background: #dbc06c !important;
    color: #000 !important;
    border-radius: 100px;
    text-decoration: none;
    text-align: center;
    font-size: 1.1rem !important;
    padding: 0.8rem 2.5rem !important;
    letter-spacing: 0.25em !important;
  }

  #overlayOffframeBtn {
    background: #2a2a2a;
    border: 1px solid #444;
    color: #8f8f8f;
    border-radius: 100px;
    font-size: 1.1rem;
    padding: 0.8rem 2.5rem;
    letter-spacing: 0.25em;
  }

  #overlayOffframeBtn:hover {
    border-color: #666;
    color: #999;
  }

  #overlayOffframeBtn.active {
    background: #fff;
    border-color: #fff;
    color: #000;
    box-shadow: 0 0 12px rgba(255, 255, 255, 0.6), 0 0 24px rgba(255, 255, 255, 0.2);
  }

  .po-close-mobile {
    display: none;
  }

  .po-btn.active {
    background: #fff;
    border-color: #fff;
    color: #000;
    box-shadow: 0 0 12px rgba(255,255,255,0.6), 0 0 24px rgba(255,255,255,0.2);
  }

    @media (max-width: 930px) {
    .po-note {}
    .po-catch {margin-left: 0.2rem;}
    .po-text {gap: 0.3rem;}
  }

  @media (max-width: 840px) {
    .po-inner { padding: 2rem 1rem; gap: 1.3rem; width: min(900px, 72vw); }
    .po-arrow { font-size: 1rem; color: #a0a0a0;}
    .po-text {
      flex-direction: column;
      align-items: center;
      gap: 0.75rem;
      text-align: center;
    }
    .po-catch { white-space: normal; order: 1; }
    .po-note { text-align: center; font-size: 0.7rem; line-height: 1.7; order: 3; }
    .po-note-guest { font-size: 0.75rem !important; line-height: 1.8 !important; }
    .po-btns { order: 2; }
    .po-btns { width: 80%; align-self: center; }
    .po-btns .po-btn,
    .po-btns #overlayOffframeBtn,
    .po-btns .po-btn-premium { width: 100%; padding: 1rem 0 !important; font-size: 1.05rem !important; box-sizing: border-box; border: 1px solid transparent; }
    .po-btns #overlayOffframeBtn { border-color: #444; }
    .po-btns .po-btn-premium { border-color: #dbc06c; }
    .po-label {top: 0.5rem; font-size: 0.7rem;}
    .po-close-mobile {
      display: block;
      background: transparent;
      border: none;
      font-family: "Shippori Mincho", serif;
      font-size: 0.75rem;
      letter-spacing: 0.15em;
      color: #fff;
      opacity: 0.5;
      cursor: pointer;
      padding: 0.5rem 0 0;
      transition: opacity 0.2s;
    }
    .po-close-mobile:hover { opacity: 1; }

  }
</style>

<script is:inline>
  window.openPromoOverlay = function() {
    var el = document.getElementById("promoOverlay");
    if (!el) return;
    el.style.display = "flex";
    document.body.style.overflow = "hidden";

    // ログイン状態チェック
    var sbKey = Object.keys(localStorage).find(function(k) { return k.startsWith("sb-") && k.endsWith("-auth-token"); });
    var isLoggedIn = sbKey ? !!localStorage.getItem(sbKey) : false;

    var offBtn = document.getElementById("overlayOffframeBtn");
    var premBtn = document.getElementById("overlayPremiumBtn");
    var noteLoggedIn = document.getElementById("promoNoteLoggedIn");
    var noteGuest = document.getElementById("promoNoteGuest");
    var isPremium = localStorage.getItem("offframe_premium") === "1";

    if (isLoggedIn) {
      if (noteLoggedIn) { noteLoggedIn.style.display = ""; }
      if (noteGuest) { noteGuest.style.display = "none"; }
      if (isPremium) {
        if (offBtn) { offBtn.style.display = "none"; }
        if (premBtn) {
          var isActive = localStorage.getItem("offframe") === "1";
          premBtn.classList.toggle("active", isActive);
        }
      } else {
        if (offBtn) {
          offBtn.style.display = "";
          var isActive = localStorage.getItem("offframe") === "1";
          offBtn.classList.toggle("active", isActive);
        }
        if (premBtn) { premBtn.style.display = ""; }
      }
    } else {
      if (noteLoggedIn) { noteLoggedIn.style.display = "none"; }
      if (noteGuest) { noteGuest.style.display = ""; }
    }
  };

  function isUserLoggedIn() {
    var sbKey = Object.keys(localStorage).find(function(k) { return k.startsWith("sb-") && k.endsWith("-auth-token"); });
    return sbKey ? !!localStorage.getItem(sbKey) : false;
  }

  window.handleOverlayStandard = function() {
    if (!isUserLoggedIn()) {
      window.closePromoOverlay();
      window.openAuthModal?.();
      return;
    }
    window.toggleOverlayOffframe("standard");
  };

  window.handleOverlayPremium = function() {
    if (!isUserLoggedIn()) {
      window.closePromoOverlay();
      window.openAuthModal?.();
      return;
    }
    if (localStorage.getItem("offframe_premium") === "1") {
      // プレミアム: OFFフレーム切替（全画像）
      window.toggleOverlayOffframe("all");
    } else {
      window.closePromoOverlay();
      location.href = "/mypage#premiumCard";
    }
  };

  window.closePromoOverlay = function() {
    var el = document.getElementById("promoOverlay");
    if (!el) return;
    el.style.display = "none";
    document.body.style.overflow = "";
  };

  window.toggleOverlayOffframe = function(scope) {
    var next = localStorage.getItem("offframe") === "1" ? "0" : "1";
    localStorage.setItem("offframe", next);
    var active = next === "1";

    // オーバーレイ内ボタン
    var btn = document.getElementById("overlayOffframeBtn");
    if (btn) {
      btn.classList.toggle("active", active);
      btn.textContent = "Standard";
    }

    // サイドナビのボタンも同期
    ["offframeBtn", "drawerOffframeBtn"].forEach(function(id) {
      var b = document.getElementById(id);
      if (b) {
        b.classList.toggle("active", active);
        b.textContent = "Standard";
      }
    });

    // 画像切替
    var selector = scope === "all" ? "img.switchable" : 'img.switchable[data-tier="standard"]';
    var imgs = document.querySelectorAll(selector);
    imgs.forEach(function(img) { img.classList.add("blurring"); });
    setTimeout(function() {
      imgs.forEach(function(img) {
        img.src = active ? img.dataset.full : img.dataset.general;
      });
      setTimeout(function() {
        imgs.forEach(function(img) { img.classList.remove("blurring"); });
      }, 100);
    }, 300);
  };

  // 背景クリックで閉じる
  document.addEventListener("click", function(e) {
    if (e.target && e.target.id === "promoOverlay") {
      window.closePromoOverlay();
    }
  });

  // ESCで閉じる
  document.addEventListener("keydown", function(e) {
    if (e.key === "Escape") window.closePromoOverlay();
  });
</script>