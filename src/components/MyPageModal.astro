---
---

<div class="mypage-overlay" id="mypageOverlay">
  <div class="mypage-modal">
    <button class="mypage-close" id="mypageClose">×</button>

    <!-- ようこそ（初回のみ） -->
    <div class="mypage-welcome" id="mypageWelcome" style="display:none;">
      <p class="welcome-sub">OFF FRAME へ</p>
      <h2 class="welcome-title">ようこそ。</h2>
      <p class="welcome-message">素の、その時間。<br>ごゆっくりお楽しみください。</p>
      <div class="welcome-divider"></div>
    </div>

    <!-- 未課金：Premium案内 -->
    <div class="mypage-section" id="mypageFree">
      <p class="mypage-label">MyPage</p>
      <h3 class="mypage-plan-title">OFF FRAME Premium</h3>
      <p class="mypage-plan-desc">全画像にフルアクセス。<br>素の写真を、余すことなく。</p>
      <div class="mypage-price">
        <span class="price-amount">¥500</span>
        <span class="price-period">/ 月</span>
      </div>
      <button class="mypage-cta" id="mypageSubscribeBtn">プレミアムに登録する</button>
    </div>

    <!-- 課金済み：プラン確認 -->
    <div class="mypage-section" id="mypagePremium" style="display:none;">
      <p class="mypage-label">MyPage</p>
      <h3 class="mypage-plan-title">OFF FRAME Premium</h3>
      <div class="mypage-status-row">
        <span class="status-dot"></span>
        <span class="status-text">プレミアム会員</span>
      </div>
      <p class="mypage-plan-sub">月額 ¥500 / 全画像フルアクセス</p>
      <p class="mypage-cancel-notice" id="mypageCancelNotice" style="display:none;"></p>
      <button class="mypage-cancel-btn" id="mypageCancelBtn">解約する</button>
    </div>

  </div>
</div>

<!-- 解約確認 -->
<div class="cancel-overlay" id="cancelOverlay">
  <div class="cancel-dialog">
    <p class="cancel-text" id="mypageCancelText">解約しますか？</p>
    <div class="cancel-btns">
      <button class="cancel-btn-yes" id="cancelYes">解約する</button>
      <button class="cancel-btn-no" id="cancelNo">戻る</button>
    </div>
  </div>
</div>

<!-- 解約完了 -->
<div class="cancel-overlay" id="cancelDoneOverlay">
  <div class="cancel-done-dialog">
    <p class="cancel-done-title">解約完了いたしました。</p>
    <p class="cancel-done-message" id="cancelDoneMessage"></p>
  </div>
</div>

<style>
  /* ============ オーバーレイ ============ */
  .mypage-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 500;
    align-items: center;
    justify-content: center;
  }

  .mypage-overlay.open {
    display: flex;
  }

  .mypage-modal {
    background: #fff;
    width: 90%;
    max-width: 360px;
    padding: 3rem 2.5rem 2.5rem;
    position: relative;
  }

  .mypage-close {
    position: absolute;
    top: 1rem;
    right: 1.25rem;
    background: transparent;
    border: none;
    font-family: "Cormorant Garamond", serif;
    font-size: 1.5rem;
    color: #000;
    opacity: 0.4;
    cursor: pointer;
    line-height: 1;
  }

  .mypage-close:hover { opacity: 1; }

  /* ============ ようこそ ============ */
  .mypage-welcome {
    text-align: center;
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid #eee;
  }

  .welcome-sub {
    font-family: "Cormorant Garamond", serif;
    font-weight: 300;
    font-size: 0.7rem;
    letter-spacing: 0.3em;
    color: #000;
    opacity: 0.4;
    margin: 0 0 0.4rem;
  }

  .welcome-title {
    font-family: "Cormorant Garamond", serif;
    font-weight: 300;
    font-size: 2rem;
    letter-spacing: 0.3em;
    color: #000;
    margin: 0 0 0.75rem;
  }

  .welcome-message {
    font-family: "Shippori Mincho", serif;
    font-size: 0.82rem;
    line-height: 2.2;
    color: #666;
    margin: 0;
  }

  .welcome-divider {
    display: none;
  }

  /* ============ マイページ共通 ============ */
  .mypage-label {
    font-family: "Cormorant Garamond", serif;
    font-weight: 300;
    font-size: 0.7rem;
    letter-spacing: 0.3em;
    color: #000;
    opacity: 0.4;
    margin: 0 0 0.75rem;
  }

  .mypage-plan-title {
    font-family: "Cormorant Garamond", serif;
    font-weight: 300;
    font-size: 1.4rem;
    letter-spacing: 0.2em;
    color: #000;
    margin: 0 0 0.75rem;
  }

  /* ============ 未課金 ============ */
  .mypage-plan-desc {
    font-family: "Shippori Mincho", serif;
    font-size: 0.82rem;
    line-height: 2;
    color: #555;
    margin: 0 0 1.5rem;
  }

  .mypage-price {
    display: flex;
    align-items: baseline;
    gap: 0.25rem;
    margin-bottom: 1.5rem;
  }

  .price-amount {
    font-family: "Cormorant Garamond", serif;
    font-weight: 300;
    font-size: 2.2rem;
    letter-spacing: 0.05em;
    color: #000;
  }

  .price-period {
    font-family: "Shippori Mincho", serif;
    font-size: 0.8rem;
    color: #888;
  }

  .mypage-cta {
    display: block;
    width: 100%;
    background: #000;
    color: #fff;
    border: none;
    padding: 0.9rem;
    font-family: "Cormorant Garamond", serif;
    font-weight: 300;
    font-size: 0.95rem;
    letter-spacing: 0.25em;
    cursor: pointer;
    transition: opacity 0.2s;
  }

  .mypage-cta:hover { opacity: 0.75; }

  /* ============ 課金済み ============ */
  .mypage-status-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }

  .status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #4ade80;
    flex-shrink: 0;
  }

  .status-text {
    font-family: "Shippori Mincho", serif;
    font-size: 0.8rem;
    letter-spacing: 0.1em;
    color: #333;
  }

  .mypage-plan-sub {
    font-family: "Shippori Mincho", serif;
    font-size: 0.78rem;
    color: #888;
    margin: 0 0 2rem;
  }

  .mypage-cancel-btn {
    background: transparent;
    border: none;
    border-bottom: 1px solid #ccc;
    padding: 0.2rem 0;
    font-family: "Shippori Mincho", serif;
    font-size: 0.75rem;
    color: #aaa;
    cursor: pointer;
    letter-spacing: 0.1em;
    transition: color 0.2s;
  }

  .mypage-cancel-btn:hover { color: #000; }

  .mypage-cancel-notice {
    font-family: "Shippori Mincho", serif;
    font-size: 0.82rem;
    line-height: 2;
    color: #c00;
    margin: 0 0 0.5rem;
  }

  /* ============ 解約確認 ============ */
  .cancel-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 600;
    align-items: center;
    justify-content: center;
  }

  .cancel-overlay.open {
    display: flex;
  }

  .cancel-dialog {
    background: #fff;
    padding: 2.5rem 2.5rem 2rem;
    width: 90%;
    max-width: 300px;
    text-align: center;
  }

  .cancel-text {
    font-family: "Shippori Mincho", serif;
    font-size: 1.2rem;
    letter-spacing: 0.12em;
    color: #000;
    line-height: 1.8;
    margin: 0 0 1.5rem;
  }

  :global(.cancel-sub) {
    display: block;
    font-size: 0.72rem;
    letter-spacing: 0.18em;
    line-height: 1.4;
    color: #888;
    margin-top: 0.5rem;
  }

  .cancel-btns {
    display: flex;
    gap: 1rem;
    justify-content: center;
  }

  .cancel-btn-yes {
    font-family: "Cormorant Garamond", serif;
    font-weight: 300;
    font-size: 0.9rem;
    letter-spacing: 0.2em;
    background: #000;
    color: #fff;
    border: none;
    padding: 0.6rem 1.5rem;
    cursor: pointer;
    transition: opacity 0.2s;
  }

  .cancel-btn-yes:hover { opacity: 0.75; }

  .cancel-btn-no {
    font-family: "Cormorant Garamond", serif;
    font-weight: 300;
    font-size: 0.9rem;
    letter-spacing: 0.2em;
    background: transparent;
    color: #000;
    border: 1px solid #ccc;
    padding: 0.6rem 1.5rem;
    cursor: pointer;
    transition: opacity 0.2s;
  }

  .cancel-btn-no:hover { opacity: 0.6; }

  /* ============ 解約完了 ============ */
  .cancel-done-dialog {
    background: #fff;
    padding: 2.5rem 2.5rem 2rem;
    width: 90%;
    max-width: 320px;
    text-align: center;
  }

  .cancel-done-title {
    font-family: "Shippori Mincho", serif;
    font-size: 1rem;
    letter-spacing: 0.1em;
    color: #000;
    margin: 0 0 1.5rem;
  }

  .cancel-done-message {
    font-family: "Shippori Mincho", serif;
    font-size: 0.8rem;
    line-height: 2;
    color: #555;
    margin: 0 0 0.5rem;
  }
</style>

<script is:inline>
  function initMyPage() {
    const overlay     = document.getElementById("mypageOverlay");
    const closeBtn    = document.getElementById("mypageClose");
    const welcomeEl   = document.getElementById("mypageWelcome");
    const freeEl      = document.getElementById("mypageFree");
    const premiumEl   = document.getElementById("mypagePremium");
    const cancelOverlay = document.getElementById("cancelOverlay");

    if (!overlay) return;

    // マイページを開く
    window.openMyPage = (showWelcome = false) => {
      // ようこそ表示（初回のみ）
      if (showWelcome) {
        welcomeEl.style.display = "block";
        localStorage.setItem("offframe_welcomed", "1");
      } else {
        welcomeEl.style.display = "none";
      }

      const isPremium = localStorage.getItem("offframe_premium") === "1";
      const isCancelling = localStorage.getItem("offframe_cancel_at") === "1";
      const periodEnd = localStorage.getItem("offframe_period_end");
      freeEl.style.display    = isPremium ? "none"  : "block";
      premiumEl.style.display = isPremium ? "block" : "none";

      var notice = document.getElementById("mypageCancelNotice");
      var cancelBtn2 = document.getElementById("mypageCancelBtn");
      if (isCancelling && isPremium && periodEnd) {
        var d = new Date(periodEnd);
        var dateStr = d.getFullYear() + "年" + (d.getMonth() + 1) + "月" + d.getDate() + "日";
        notice.textContent = dateStr + "にプレミアム機能が停止されます。";
        notice.style.display = "block";
        cancelBtn2.style.display = "none";
      } else {
        notice.style.display = "none";
        cancelBtn2.style.display = "";
      }

      overlay.classList.add("open");
    };

    // 閉じる
    closeBtn.addEventListener("click", () => overlay.classList.remove("open"));
    overlay.addEventListener("click", (e) => {
      if (e.target === overlay) overlay.classList.remove("open");
    });

    // プレミアム登録ボタン → Stripe Checkout
    document.getElementById("mypageSubscribeBtn").addEventListener("click", async function() {
      var sbKey = Object.keys(localStorage).find(function(k) { return k.startsWith("sb-") && k.endsWith("-auth-token"); });
      if (!sbKey) { window.openAuthModal?.(); return; }
      var tokenData = JSON.parse(localStorage.getItem(sbKey) || "{}");
      var accessToken = tokenData.access_token;
      if (!accessToken) { window.openAuthModal?.(); return; }

      var btn = this;
      btn.textContent = "処理中...";
      btn.disabled = true;

      try {
        var res = await fetch("https://gupwbkyehfyrymybrhee.supabase.co/functions/v1/create-checkout-session", {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + accessToken,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ return_url: location.origin })
        });
        var data = await res.json();
        if (data.url) {
          location.href = data.url;
        } else {
          alert(data.error || "エラーが発生しました");
          btn.textContent = "プレミアムに登録する";
          btn.disabled = false;
        }
      } catch (e) {
        console.error(e);
        alert("エラーが発生しました");
        btn.textContent = "プレミアムに登録する";
        btn.disabled = false;
      }
    });

    // 解約ボタン
    document.getElementById("mypageCancelBtn").addEventListener("click", function() {
      var periodEnd = localStorage.getItem("offframe_period_end");
      var cancelText = document.getElementById("mypageCancelText");
      if (cancelText) {
        if (periodEnd) {
          var d = new Date(periodEnd);
          var dateStr = d.getFullYear() + "年" + (d.getMonth() + 1) + "月" + d.getDate() + "日";
          cancelText.innerHTML = "解約しますか？<br><span class='cancel-sub'>解約しても" + dateStr + "までは<br>引き続きご利用いただけます。</span>";
        } else {
          cancelText.innerHTML = "解約しますか？<br><span class='cancel-sub'>解約しても現在の請求期間の終了までは<br>引き続きご利用いただけます。</span>";
        }
      }
      cancelOverlay.classList.add("open");
    });

    document.getElementById("cancelNo").addEventListener("click", () => {
      cancelOverlay.classList.remove("open");
    });

    document.getElementById("cancelYes").addEventListener("click", async function() {
      var sbKey = Object.keys(localStorage).find(function(k) { return k.startsWith("sb-") && k.endsWith("-auth-token"); });
      var tokenData = sbKey ? JSON.parse(localStorage.getItem(sbKey) || "{}") : {};
      var accessToken = tokenData.access_token;

      if (!accessToken) {
        alert("認証エラーが発生しました");
        return;
      }

      var btn = this;
      btn.textContent = "処理中...";
      btn.disabled = true;

      try {
        var res = await fetch("https://gupwbkyehfyrymybrhee.supabase.co/functions/v1/cancel-subscription", {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + accessToken,
            "Content-Type": "application/json"
          }
        });
        var data = await res.json();
        if (data.success) {
          localStorage.setItem("offframe_cancel_at", "1");
          cancelOverlay.classList.remove("open");
          // 解約完了モーダルに日付を表示
          var periodEnd = localStorage.getItem("offframe_period_end");
          var doneOverlay = document.getElementById("cancelDoneOverlay");
          var doneMsg = document.getElementById("cancelDoneMessage");
          if (doneMsg) {
            if (periodEnd) {
              var d = new Date(periodEnd);
              var dateStr = d.getFullYear() + "年" + (d.getMonth() + 1) + "月" + d.getDate() + "日";
              doneMsg.innerHTML = dateStr + "までは<br>引き続きご利用いただけます。";
            } else {
              doneMsg.innerHTML = "現在の請求期間の終了までは<br>引き続きご利用いただけます。";
            }
          }
          overlay.classList.remove("open");
          doneOverlay.classList.add("open");
          doneOverlay.addEventListener("click", function(e) {
            if (e.target === doneOverlay) { doneOverlay.classList.remove("open"); }
          });
        } else {
          alert(data.error || "解約に失敗しました");
          btn.textContent = "解約する";
          btn.disabled = false;
        }
      } catch (e) {
        console.error(e);
        alert("エラーが発生しました");
        btn.textContent = "解約する";
        btn.disabled = false;
      }
    });
  }

  document.addEventListener("astro:page-load", initMyPage);
  initMyPage();
</script>