---
const SUPABASE_URL = "https://gupwbkyehfyrymybrhee.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd1cHdia3llaGZ5cnlteWJyaGVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5MzAzMTgsImV4cCI6MjA4NzUwNjMxOH0.U0nVl7YCwckRRHmCIUqTvxns15L7rEQcZ28OOtxTAU0";
---

<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>パスワード再設定 - OFF FRAME</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&family=Shippori+Mincho:wght@400;500&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="reset-page">
      <!-- パスワード再設定フォーム -->
      <div class="reset-card" id="resetCard">
        <p class="reset-logo">OFF FRAME</p>
        <h1 class="reset-title">パスワード再設定</h1>
        <p class="reset-desc">新しいパスワードを入力してください。</p>
        <input class="reset-input" id="newPassword" type="password" placeholder="新しいパスワード（6文字以上）" />
        <input class="reset-input" id="confirmPassword" type="password" placeholder="パスワード確認" />
        <p class="reset-error" id="resetError"></p>
        <button class="reset-btn" id="resetBtn">パスワードを変更する</button>
      </div>

      <!-- 完了画面 -->
      <div class="reset-card" id="doneCard" style="display:none;">
        <p class="reset-logo">OFF FRAME</p>
        <h1 class="reset-title">変更完了</h1>
        <p class="reset-desc">パスワードが変更されました。</p>
        <a href="/" class="reset-btn reset-link">トップページへ</a>
      </div>
    </div>

    <style>
      *, *::before, *::after { box-sizing: border-box; }

      body {
        margin: 0;
        background: #000;
        font-family: "Shippori Mincho", serif;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
      }

      .reset-page {
        width: 90%;
        max-width: 360px;
      }

      .reset-card {
        background: #fff;
        padding: 3rem 2.5rem 2.5rem;
      }

      .reset-logo {
        font-family: "Cormorant Garamond", serif;
        font-weight: 300;
        font-size: 0.8rem;
        letter-spacing: 0.3em;
        color: #000;
        opacity: 0.3;
        margin: 0 0 2rem;
      }

      .reset-title {
        font-family: "Cormorant Garamond", serif;
        font-weight: 300;
        font-size: 1.6rem;
        letter-spacing: 0.15em;
        color: #000;
        margin: 0 0 0.5rem;
      }

      .reset-desc {
        font-size: 0.78rem;
        line-height: 2;
        color: #888;
        margin: 0 0 1.5rem;
      }

      .reset-input {
        display: block;
        width: 100%;
        border: none;
        border-bottom: 1px solid #ccc;
        padding: 0.6rem 0;
        font-family: "Shippori Mincho", serif;
        font-size: 16px;
        letter-spacing: 0.05em;
        color: #000;
        background: transparent;
        outline: none;
        margin-bottom: 1.25rem;
      }

      .reset-input::placeholder { color: #aaa; }
      .reset-input:focus { border-bottom-color: #000; }

      .reset-error {
        font-family: "Shippori Mincho", serif;
        font-size: 0.75rem;
        color: #c00;
        margin: -0.5rem 0 1rem;
        min-height: 1rem;
      }

      .reset-btn {
        display: block;
        width: 100%;
        background: #000;
        color: #fff;
        border: none;
        padding: 0.85rem;
        font-family: "Cormorant Garamond", serif;
        font-weight: 300;
        font-size: 1rem;
        letter-spacing: 0.3em;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        transition: opacity 0.2s;
      }

      .reset-btn:hover { opacity: 0.75; }
    </style>

    <script is:inline src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script define:vars={{ SUPABASE_URL, SUPABASE_KEY }}>
      function initReset() {
        if (!window.supabase) { setTimeout(initReset, 100); return; }
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        document.getElementById("resetBtn").addEventListener("click", async () => {
          const pw = document.getElementById("newPassword").value;
          const confirm = document.getElementById("confirmPassword").value;
          const errorEl = document.getElementById("resetError");

          if (pw.length < 6) {
            errorEl.textContent = "パスワードは6文字以上で入力してください。";
            return;
          }
          if (pw !== confirm) {
            errorEl.textContent = "パスワードが一致しません。";
            return;
          }

          const { error } = await sb.auth.updateUser({ password: pw });
          if (error) {
            errorEl.textContent = "変更に失敗しました。リンクの有効期限が切れている可能性があります。";
          } else {
            document.getElementById("resetCard").style.display = "none";
            document.getElementById("doneCard").style.display = "block";
          }
        });
      }
      initReset();
    </script>
  </body>
</html>
