---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import Card from "../../components/Card.astro";
import AdBanner from "../../components/AdBanner.astro";
import Promo from "../../components/Promo.astro";
import { standardPhotos } from "../../data/standard";

// ============ 広告設定 ============
const SHOW_ADS = true;
const AD_POSITIONS_BOTTOM = [1, 5];
const AD_POSITIONS_SIDE   = [2, 4, 6, 8];

type PromoVariant = "offframe" | "new" | "about";

const AD_PROMOS_BOTTOM: (PromoVariant | undefined)[] = [
  "offframe",
  "offframe",
];

const AD_PROMOS_SIDE: (PromoVariant | undefined)[] = [
  "offframe",
  "offframe",
  "offframe",
  "offframe",
];

export async function getStaticPaths() {
  const photos = await getCollection("photos");
  return photos.map((photo) => ({
    params: { slug: photo.data.title.replace(":", "") },
    props: { photo },
  }));
}

// ============ データ取得 ============
const { photo } = Astro.props;
const { title } = photo.data;
const { Content } = await photo.render();
const id         = title.replace(":", "");
const isStandard = standardPhotos.includes(id);
const generalSrc = `/images/high/${id}.webp`;
const fullSrc    = `/images/full_high/${id}.webp`;

const all    = await getCollection("photos");
const others = all.filter((p) => p.data.title !== title);

const half        = Math.ceil(others.length / 2);
const relatedSide = others.slice(0, half);   // サイドバー用（前半）
const relatedPC   = others.slice(half);      // PC記事下用（後半）

type AdItem = { __ad: true; promo: PromoVariant | undefined };
type Item = typeof others[number] | AdItem;

// PC記事下（後半）
const relatedWithAds: Item[] = SHOW_ADS
  ? relatedPC.flatMap((p, i) => {
      const adIdx = AD_POSITIONS_BOTTOM.indexOf(i);
      return adIdx !== -1
        ? [{ __ad: true as const, promo: AD_PROMOS_BOTTOM[adIdx] }, p]
        : [p];
    })
  : relatedPC;

// サイドバー（前半）
const relatedSideWithAds: Item[] = SHOW_ADS
  ? relatedSide.flatMap((p, i) => {
      const adIdx = AD_POSITIONS_SIDE.indexOf(i);
      return adIdx !== -1
        ? [{ __ad: true as const, promo: AD_PROMOS_SIDE[adIdx] }, p]
        : [p];
    })
  : relatedSide;

// スマホ記事下（全記事）
const allWithAds: Item[] = SHOW_ADS
  ? others.flatMap((p, i) => {
      const adIdx = AD_POSITIONS_BOTTOM.indexOf(i);
      return adIdx !== -1
        ? [{ __ad: true as const, promo: AD_PROMOS_BOTTOM[adIdx] }, p]
        : [p];
    })
  : others;

const bottomCol1 = allWithAds.filter((_, i) => i % 2 === 0);
const bottomCol2 = allWithAds.filter((_, i) => i % 2 === 1);
---

<BaseLayout title={title}>
  <main>
    <div class="layout">

      <!-- メインカラム -->
      <div class="main-col">

        <!-- メイン写真カード -->
        <div class="card">
          <div class="inner">
            <img
              src={generalSrc}
              data-general={generalSrc}
              data-full={fullSrc}
              data-tier={isStandard ? "standard" : "premium"}
              alt={title}
              class="switchable"
            />
            {isStandard
              ? <span class="tier-tag standard-tag">Standard</span>
              : <span class="tier-tag premium-tag">Premium</span>
            }
            <div class="text">
              <span class="title">
                {title.split(":")[0]}<span class="colon">:</span>{title.split(":")[1]}
              </span>
              <div class="body">
                <Content />
              </div>
            </div>
          </div>
        </div>

        <!-- 広告バナー（記事下） -->
        {SHOW_ADS && (
          <div class="ad-wrap">
            <AdBanner variant="horizontal">
              <Promo variant="offframe" size="horizontal" />
            </AdBanner>
          </div>
        )}

        <!-- モバイルボタン（サイドバー非表示時） -->
        <div class="mobile-offframe-wrap" data-photo-tier={isStandard ? "standard" : "premium"}>
          <button class="mobile-standard-btn" id="mobileStandardBtn">Standard</button>
          <button class="mobile-premium-btn" id="mobilePremiumBtn">Premium</button>
        </div>

        <!-- 関連カード：PC -->
        <div class="related-bottom-pc">
          {relatedWithAds.map((item) =>
            "__ad" in item ? (
              <AdBanner variant="card">
                {item.promo && <Promo variant={item.promo} size="card" />}
              </AdBanner>
            ) : (
              <Card title={item.data.title} />
            )
          )}
        </div>

        <!-- 関連カード：スマホ（全記事） -->
        <div class="related-bottom-mobile">
          <div class="col">
            {bottomCol1.map((item) =>
              "__ad" in item ? (
                <AdBanner variant="card">
                  {item.promo && <Promo variant={item.promo} size="card" />}
                </AdBanner>
              ) : (
                <Card title={item.data.title} />
              )
            )}
          </div>
          <div class="col">
            {bottomCol2.map((item) =>
              "__ad" in item ? (
                <AdBanner variant="card">
                  {item.promo && <Promo variant={item.promo} size="card" />}
                </AdBanner>
              ) : (
                <Card title={item.data.title} />
              )
            )}
          </div>
        </div>

      </div>

      <!-- サイドバー -->
      <aside class="related-side">
        {relatedSideWithAds.map((item) =>
          "__ad" in item ? (
            <AdBanner variant="card">
              {item.promo && <Promo variant={item.promo} size="card" />}
            </AdBanner>
          ) : (
            <Card title={item.data.title} />
          )
        )}
      </aside>

    </div>
  </main>
</BaseLayout>

<style>
  main {
    background: #000;
    padding: 2rem;
  }

  .layout {
    display: flex;
    flex-direction: row;
    align-items: flex-start;
    gap: 1rem;
  }

  .main-col {
    flex: 1;
    min-width: 0;
    max-width: 600px;
  }

  .card {
    background: #fff;
    width: 100%;
    padding: 8% 5%;
    display: flex;
    align-items: flex-start;
    justify-content: center;
  }

  .inner {
    position: relative;
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: flex-start;
    width: 100%;
  }

  .card img {
    width: 90%;
    height: auto;
    display: block;
  }

  .text {
    position: absolute;
    top: 0;
    left: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    max-width: 50%;
  }

  .title {
    font-family: "Cormorant Garamond", serif;
    font-weight: 300;
    font-size: 2rem;
    letter-spacing: 0.2em;
    line-height: 1;
    margin: 0;
    padding: 0 0.6rem 1rem 0.75rem;
    color: #000;
    background: #fff;
    display: inline;
    width: fit-content;
  }

  .colon {
    animation: blink 2.5s step-start infinite;
  }

  @keyframes blink {
    0%, 80%     { opacity: 1; }
    80.1%, 100% { opacity: 0; }
  }

  .body :global(p) {
    font-family: "Shippori Mincho", serif;
    font-size: 0.9rem;
    line-height: 2.2;
    color: #000;
    margin: 0;
    background: #fff;
    display: inline;
    padding: 0.1rem 0.75rem;
    box-decoration-break: clone;
    -webkit-box-decoration-break: clone;
  }

  .tier-tag {
    position: absolute;
    bottom: -1.5rem;
    right: 5%;
    font-family: "Cormorant Garamond", serif;
    font-weight: 300;
    font-size: 0.75rem;
    letter-spacing: 0.1em;
  }

  .standard-tag { color: #aaa; }
  .premium-tag { color: #c9a84c; }

  .ad-wrap {
    margin-top: 1rem;
  }

  .mobile-offframe-wrap {
    display: none;
  }

  .mobile-standard-btn,
  .mobile-premium-btn {
    font-family: "Cormorant Garamond", serif;
    font-weight: 300;
    font-size: 1.1rem;
    letter-spacing: 0.25em;
    border-radius: 100px;
    padding: 0.8rem 2.5rem;
    cursor: pointer;
    transition: all 0.25s ease;
    width: 100%;
  }

  .mobile-standard-btn {
    background: #2a2a2a;
    border: 1px solid #444;
    color: #8f8f8f;
  }

  .mobile-standard-btn:hover:not(.active) {
    border-color: #666;
    color: #999;
  }

  .mobile-standard-btn.active {
    background: #fff;
    border-color: #fff;
    color: #000;
    box-shadow: 0 0 12px rgba(255,255,255,0.6), 0 0 24px rgba(255,255,255,0.2);
  }

  .mobile-premium-btn {
    background: #dbc06c;
    color: #000;
    border: 1px solid #dbc06c;
  }

  .mobile-premium-btn:hover:not(.active) { opacity: 0.75; }

  .mobile-premium-btn.active {
    background: #fff;
    border-color: #fff;
    color: #000;
    box-shadow: 0 0 12px rgba(255,255,255,0.6), 0 0 24px rgba(255,255,255,0.2);
  }

  .related-bottom-pc {
    display: block;
    columns: 2;
    column-gap: 1rem;
    margin-top: 1rem;
  }

  .related-bottom-pc > :global(a),
  .related-bottom-pc > :global(.ad-banner) {
    break-inside: avoid;
    margin-bottom: 1rem;
    display: block;
  }

  .related-bottom-mobile {
    display: none;
  }

  .col {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .related-side {
    display: none;
    flex-shrink: 0;
  }

  .related-side > :global(a),
  .related-side > :global(.ad-banner) {
    break-inside: avoid;
    margin-bottom: 1rem;
    display: block;
  }

  .related-side > :global(a:nth-child(n+7)) { display: block; }

  @media (min-width: 850px) {
    .related-side { display: block; columns: 1; width: 350px; }
  }

  @media (min-width: 1000px) {
    .related-side { width: 400px; }
  }

  @media (min-width: 1200px) {
    .related-side { columns: 2; width: 550px; }
    .related-side > :global(a:nth-child(n+13)) { display: none; }
  }

  @media (min-width: 1300px) {
    .related-side { width: 600px; }
  }

  @media (min-width: 1400px) {
    .related-side { width: 700px; }
  }

  @media (min-width: 1500px) {
    .related-side { columns: 3; width: 800px; }
    .related-side > :global(a:nth-child(n+13)) { display: block; }
  }

  @media (min-width: 1600px) {
    .related-side { width: 900px; }
  }

  @media (max-width: 728px) {
    main { padding: 0; }

    .layout { flex-direction: column; gap: 0; }

    .card { background: #000; padding: 0; flex-direction: column; }

    .inner { flex-direction: column; align-items: flex-start; }

    .card img { width: 100%; margin-top: 1rem; }

    .tier-tag { display: none; }

    .text { top: 1rem; left: 1rem; align-items: flex-end; max-width: 50%; }

    .body :global(p) {
      display: inline;
      box-decoration-break: clone;
      -webkit-box-decoration-break: clone;
    }

    .related-bottom-pc { display: none; }

    .related-bottom-mobile {
      display: flex;
      flex-direction: row;
      gap: 1rem;
      align-items: flex-start;
      padding: 1rem;
    }

    .ad-wrap { display: none; }

    .mobile-offframe-wrap {
      display: flex;
      justify-content: center;
      padding: 1rem 4rem;
    }
  }
</style>

<script>
  function shuffleChildren(container: Element) {
    const items = Array.from(container.children);
    for (let i = items.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      container.appendChild(items[j]);
      items.splice(j, 1);
    }
  }

  function shuffleGrids() {
    const pc = document.querySelector(".related-bottom-pc");
    if (pc) shuffleChildren(pc);

    const side = document.querySelector(".related-side");
    if (side) shuffleChildren(side);

    document.querySelectorAll(".related-bottom-mobile .col").forEach(shuffleChildren);
  }

  function applyOffframeMode() {
    const isActive = localStorage.getItem("offframe") === "1";
    const isPremium = localStorage.getItem("offframe_premium") === "1";
    document.querySelectorAll("img.switchable").forEach((img) => {
      const el = img as HTMLImageElement;
      const tier = el.dataset.tier;
      if (isActive && (isPremium || tier === "standard")) {
        el.src = el.dataset.full!;
      } else {
        el.src = el.dataset.general!;
      }
    });
  }

  function initMobileOffframeBtns() {
    const wrap = document.querySelector(".mobile-offframe-wrap") as HTMLElement | null;
    if (!wrap) return;

    const stdBtn = document.getElementById("mobileStandardBtn") as HTMLButtonElement | null;
    const premBtn = document.getElementById("mobilePremiumBtn") as HTMLButtonElement | null;
    if (!stdBtn || !premBtn) return;

    const photoTier = wrap.dataset.photoTier; // "standard" or "premium"
    const isPremiumUser = localStorage.getItem("offframe_premium") === "1";

    const sbKey = Object.keys(localStorage).find((k) => k.startsWith("sb-") && k.endsWith("-auth-token"));
    const isLoggedIn = sbKey ? !!localStorage.getItem(sbKey) : false;
    if (!isLoggedIn && localStorage.getItem("offframe") === "1") {
      localStorage.removeItem("offframe");
    }

    // ログイン後はボタンを非表示（サイドメニューから操作）
    if (isLoggedIn) {
      wrap.style.display = "none";
      return;
    }

    if (isPremiumUser) {
      // プレミアム会員: Premiumボタンのみ表示
      stdBtn.style.display = "none";
      const isActive = localStorage.getItem("offframe") === "1";
      premBtn.classList.toggle("active", isActive);

      premBtn.onclick = () => {
        const sbKey = Object.keys(localStorage).find((k) => k.startsWith("sb-") && k.endsWith("-auth-token"));
        if (!(sbKey ? !!localStorage.getItem(sbKey) : false)) {
          (window as any).openPromoOverlay?.();
          return;
        }
        const next = localStorage.getItem("offframe") === "1" ? "0" : "1";
        localStorage.setItem("offframe", next);
        const active = next === "1";
        premBtn.classList.toggle("active", active);

        // 他ボタン同期
        ["offframeBtn", "drawerOffframeBtn"].forEach((id) => {
          const b = document.getElementById(id);
          if (b) { b.classList.toggle("active", active); b.textContent = "Standard"; }
        });
        const drawerPrem = document.getElementById("drawerPremiumBtn");
        if (drawerPrem) drawerPrem.classList.toggle("active", active);
        const overlayBtn = document.getElementById("overlayPremiumBtn");
        if (overlayBtn) overlayBtn.classList.toggle("active", active);

        // 全画像切替
        const imgs = document.querySelectorAll("img.switchable");
        imgs.forEach((img) => img.classList.add("blurring"));
        setTimeout(() => {
          imgs.forEach((img) => {
            const el = img as HTMLImageElement;
            el.src = active ? el.dataset.full! : el.dataset.general!;
          });
          setTimeout(() => { imgs.forEach((img) => img.classList.remove("blurring")); }, 100);
        }, 300);
      };
    } else {
      // 無料会員: 記事のtierに応じてボタンを出し分け
      if (photoTier === "standard") {
        // スタンダード記事 → Standardボタン
        premBtn.style.display = "none";
        const isActive = localStorage.getItem("offframe") === "1";
        stdBtn.classList.toggle("active", isActive);

        stdBtn.onclick = () => {
          const sbKey = Object.keys(localStorage).find((k) => k.startsWith("sb-") && k.endsWith("-auth-token"));
          if (!(sbKey ? !!localStorage.getItem(sbKey) : false)) {
            (window as any).openPromoOverlay?.();
            return;
          }
          const next = localStorage.getItem("offframe") === "1" ? "0" : "1";
          localStorage.setItem("offframe", next);
          const active = next === "1";
          stdBtn.classList.toggle("active", active);

          // 他ボタン同期
          ["offframeBtn", "drawerOffframeBtn"].forEach((id) => {
            const b = document.getElementById(id);
            if (b) { b.classList.toggle("active", active); b.textContent = "Standard"; }
          });
          const overlayBtn = document.getElementById("overlayOffframeBtn");
          if (overlayBtn) overlayBtn.classList.toggle("active", active);

          // Standard画像のみ切替
          const imgs = document.querySelectorAll('img.switchable[data-tier="standard"]');
          imgs.forEach((img) => img.classList.add("blurring"));
          setTimeout(() => {
            imgs.forEach((img) => {
              const el = img as HTMLImageElement;
              el.src = active ? el.dataset.full! : el.dataset.general!;
            });
            setTimeout(() => { imgs.forEach((img) => img.classList.remove("blurring")); }, 100);
          }, 300);
        };
      } else {
        // プレミアム記事 → Premiumボタン（マイページへ誘導）
        stdBtn.style.display = "none";
        premBtn.onclick = () => {
          const sbKey = Object.keys(localStorage).find((k) => k.startsWith("sb-") && k.endsWith("-auth-token"));
          if (!(sbKey ? !!localStorage.getItem(sbKey) : false)) {
            (window as any).openPromoOverlay?.();
            return;
          }
          (window as any).openPremiumModal?.();
        };
      }
    }
  }

  document.addEventListener("astro:page-load", () => {
    shuffleGrids();
    applyOffframeMode();
    initMobileOffframeBtns();
  });
  shuffleGrids();
  applyOffframeMode();
  initMobileOffframeBtns();
</script>