---
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";
import Card from "../components/Card.astro";
import AdBanner from "../components/AdBanner.astro";
import Promo from "../components/Promo.astro";

// ============ 広告設定 ============
const SHOW_ADS = true;
const AD_POSITIONS = [1, 5, 9, 13, 17, 21, 25, 29];

// 各位置の告知内容（undefinedは広告枠の空白）
type PromoVariant = "offframe" | "new" | "about";
const AD_PROMOS: (PromoVariant | undefined)[] = [
  "offframe",
  "offframe",
  "offframe",
  "offframe",
  "offframe",
  "offframe",
  "offframe",
  "offframe",
];

// ============ データ取得 ============
const photos = await getCollection("photos");
// ビルド時は固定順（クライアントでシャッフル）
const shuffled = photos;

type AdItem = { __ad: true; promo: PromoVariant | undefined };
type Item = typeof shuffled[number] | AdItem;

const withAds: Item[] = SHOW_ADS
  ? shuffled.flatMap((photo, i) => {
      const adIdx = AD_POSITIONS.indexOf(i);
      return adIdx !== -1
        ? [{ __ad: true as const, promo: AD_PROMOS[adIdx] }, photo]
        : [photo];
    })
  : shuffled;

const col1 = withAds.filter((_, i) => i % 2 === 0);
const col2 = withAds.filter((_, i) => i % 2 === 1);
---

<BaseLayout>
  <main>

    <!-- トップバナー（スマホ）※非表示 -->
    <!-- <div id="ad-mobile-wrap" style="overflow:hidden; height:0; margin-bottom:0;">
      <AdBanner variant="horizontal">
        <Promo variant="offframe" size="horizontal" />
      </AdBanner>
    </div> -->

    <!-- トップバナー（PC）※非表示 -->
    <!-- <div id="ad-pc-wrap" style="overflow:hidden; height:0; margin-bottom:0;">
      <AdBanner variant="horizontal">
        <Promo variant="offframe" size="horizontal" />
      </AdBanner>
    </div> -->

    <!-- グリッド：スマホ（flex 2カラム） -->
    <div id="grid-mobile" style="display:none;">
      <div class="col">
        {col1.map((item) =>
          "__ad" in item ? (
            <AdBanner variant="card">
              {item.promo && <>
                <Promo variant={item.promo} size="card" />
                <Promo variant="premium" size="card" />
              </>}
            </AdBanner>
          ) : (
            <Card title={item.data.title} />
          )
        )}
      </div>
      <div class="col">
        {col2.map((item) =>
          "__ad" in item ? (
            <AdBanner variant="card">
              {item.promo && <>
                <Promo variant={item.promo} size="card" />
                <Promo variant="premium" size="card" />
              </>}
            </AdBanner>
          ) : (
            <Card title={item.data.title} />
          )
        )}
      </div>
    </div>

    <!-- グリッド：PC（columnsマソンリー） -->
    <div id="grid-pc" style="display:none;">
      {withAds.map((item) =>
        "__ad" in item ? (
          <AdBanner variant="card">
            {item.promo && <>
              <Promo variant={item.promo} size="card" />
              <Promo variant="premium" size="card" />
            </>}
          </AdBanner>
        ) : (
          <Card title={item.data.title} />
        )
      )}
    </div>

  </main>
</BaseLayout>

<style>
  main {
    padding: 1rem;
    background: #000;
  }

  .col {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  #grid-mobile {
    flex-direction: row;
    gap: 1rem;
    align-items: flex-start;
  }

  #grid-pc > :global(a),
  #grid-pc > :global(.ad-banner) {
    break-inside: avoid;
    margin-bottom: 1rem;
    display: block;
  }

  @media (min-width: 1400px) {
    #grid-pc { columns: 4 !important; }
  }

  @media (min-width: 1600px) {
    #grid-pc { columns: 5 !important; }
  }
</style>

<script is:inline>
  function applyLayout() {
    var isPC = window.innerWidth >= 800;
    var adMobile   = document.getElementById("ad-mobile-wrap");
    var adPC       = document.getElementById("ad-pc-wrap");
    var gridMobile = document.getElementById("grid-mobile");
    var gridPC     = document.getElementById("grid-pc");
    if (!gridMobile || !gridPC) return;

    if (isPC) {
      if (adMobile) { adMobile.style.height = "0"; adMobile.style.marginBottom = "0"; }
      if (adPC)     { adPC.style.height = "auto"; adPC.style.marginBottom = "1rem"; }
      gridMobile.style.display = "none";
      gridPC.style.display = "block";
      gridPC.style.columns = "3";
      gridPC.style.columnGap = "1rem";
    } else {
      if (adMobile) { adMobile.style.height = "auto"; adMobile.style.marginBottom = "1rem"; }
      if (adPC)     { adPC.style.height = "0"; adPC.style.marginBottom = "0"; }
      gridMobile.style.display = "flex";
      gridPC.style.display = "none";
    }
  }

  applyLayout();
  window.addEventListener("resize", applyLayout);
  document.addEventListener("astro:page-load", applyLayout);

  // Fisher-Yatesシャッフル
  function shuffle(arr) {
    for (var i = arr.length - 1; i > 0; i--) {
      var j = Math.floor(Math.random() * (i + 1));
      var tmp = arr[i]; arr[i] = arr[j]; arr[j] = tmp;
    }
    return arr;
  }

  // 無料会員ならStandard先、それ以外はランダム
  function sortCards(cards) {
    var isPremium = localStorage.getItem("offframe_premium") === "1";
    if (isPremium) {
      return shuffle(cards);
    }
    // 無料会員: Standard → Premium（各グループ内はシャッフル）
    var std = cards.filter(function(el) { return el.querySelector("img[data-tier='standard']"); });
    var prm = cards.filter(function(el) { return !el.querySelector("img[data-tier='standard']"); });
    return shuffle(std).concat(shuffle(prm));
  }

  // PCカラム数を取得
  function getColCount() {
    var w = window.innerWidth;
    if (w >= 1600) return 5;
    if (w >= 1400) return 4;
    return 3;
  }

  // CSS columnsは上→下に流れるので、行優先の並びを列優先に変換
  // 入力: [row0col0, row0col1, row0col2, row1col0, ...]
  // 出力: [col0row0, col0row1, ..., col1row0, col1row1, ...]
  function transposeForColumns(arr, cols) {
    var n = arr.length;
    if (cols <= 1 || n <= cols) return arr;
    var rows = Math.ceil(n / cols);
    var result = [];
    for (var c = 0; c < cols; c++) {
      for (var r = 0; r < rows; r++) {
        var srcIdx = r * cols + c;
        if (srcIdx < n) {
          result.push(arr[srcIdx]);
        }
      }
    }
    return result;
  }

  // 高さベースで広告を挿入
  // cards: カード要素配列、ads: 広告要素配列、threshold: 広告を入れる累積高さ間隔
  // offset: 最初の広告を入れるまでの高さオフセット（0なら先頭から）
  function insertAdsByHeight(container, cards, ads, threshold, offset) {
    // まずカードだけ配置して高さを測る
    cards.forEach(function(c) { container.appendChild(c); });

    // 各カードの高さを取得
    var heights = cards.map(function(c) { return c.getBoundingClientRect().height; });

    // 広告挿入位置を計算
    var adPositions = [];
    var cumHeight = 0;
    var nextAdHeight = offset > 0 ? offset : threshold;
    for (var i = 0; i < cards.length; i++) {
      cumHeight += heights[i];
      if (cumHeight >= nextAdHeight && adPositions.length < ads.length) {
        adPositions.push(i + 1); // このカードの後に広告
        nextAdHeight = cumHeight + threshold;
      }
    }

    // カードと広告を再配置
    while (container.firstChild) container.removeChild(container.firstChild);
    var adIdx = 0;
    for (var i = 0; i < cards.length; i++) {
      container.appendChild(cards[i]);
      if (adIdx < adPositions.length && i + 1 === adPositions[adIdx]) {
        container.appendChild(ads[adIdx]);
        adIdx++;
      }
    }
  }

  // ログイン済み無料会員ならプレミアム誘導カードに切替
  function togglePromoVariant() {
    var sbKey = Object.keys(localStorage).find(function(k) { return k.startsWith("sb-") && k.endsWith("-auth-token"); });
    var isLoggedIn = sbKey ? !!localStorage.getItem(sbKey) : false;
    var isPremium = localStorage.getItem("offframe_premium") === "1";
    var showPremiumUpsell = isLoggedIn && !isPremium;

    document.querySelectorAll(".promo--premium-upsell").forEach(function(el) {
      el.style.display = showPremiumUpsell ? "" : "none";
    });
    document.querySelectorAll('.promo[data-variant="offframe"]').forEach(function(el) {
      el.style.display = showPremiumUpsell ? "none" : "";
    });
  }

  // カードをリロードのたびにシャッフル
  function shuffleGrids() {
    var vh = window.innerHeight;
    var isPC = window.innerWidth >= 800;

    ["grid-mobile", "grid-pc"].forEach(function(gridId) {
      var grid = document.getElementById(gridId);
      if (!grid) return;
      var items = Array.from(grid.querySelectorAll(":scope > a, :scope > .ad-banner, :scope > .col"));

      if (gridId === "grid-mobile") {
        var cols = grid.querySelectorAll(".col");
        cols.forEach(function(col, colIdx) {
          var allChildren = Array.from(col.children);
          var cards = allChildren.filter(function(el) { return !el.classList.contains("ad-banner"); });
          var ads = allChildren.filter(function(el) { return el.classList.contains("ad-banner"); });
          cards = sortCards(cards);
          // スマホ：各列2画面ごと、左右1画面ずらし→合計で1画面1枚
          var offset = colIdx === 0 ? vh * 1.5 : vh * 0.5;
          insertAdsByHeight(col, cards, ads, vh * 2, offset);
        });
      } else {
        var cards = items.filter(function(el) { return !el.classList.contains("ad-banner"); });
        var ads = items.filter(function(el) { return el.classList.contains("ad-banner"); });
        cards = sortCards(cards);
        var isPremium = localStorage.getItem("offframe_premium") === "1";
        if (!isPremium) {
          cards = transposeForColumns(cards, getColCount());
        }
        // PC：2.5画面ごとに1枚
        insertAdsByHeight(grid, cards, ads, vh * 2.5, vh * 2.5);
      }
    });
  }

  // レイアウト確定後に高さ計算するためrAFで実行
  function initGrids() {
    togglePromoVariant();
    requestAnimationFrame(function() {
      shuffleGrids();
    });
  }

  document.addEventListener("astro:page-load", initGrids);
  initGrids();

  // ログイン後にプロモ切替
  document.addEventListener("offframe:loggedin", function() {
    togglePromoVariant();
  });
</script>