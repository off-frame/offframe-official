---
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";
import Card from "../components/Card.astro";
import AdBanner from "../components/AdBanner.astro";
import Promo from "../components/Promo.astro";

// ============ 広告設定 ============
const SHOW_ADS = true;
const AD_POSITIONS = [5, 8, 11, 14, 18];

// 各位置の告知内容（undefinedは広告枠の空白）
type PromoVariant = "offframe" | "new" | "about";
const AD_PROMOS: (PromoVariant | undefined)[] = [
  "offframe",   // 位置5
  "offframe",        // 位置8
  "offframe",      // 位置11
  "offframe",   // 位置14
  "offframe",    // 位置18 → 空白
];

// ============ データ取得 ============
const photos = await getCollection("photos");
// ビルド時は固定順（クライアントでシャッフル）
const shuffled = photos;

type AdItem = { __ad: true; promo: PromoVariant | undefined };
type Item = typeof shuffled[number] | AdItem;

const withAds: Item[] = SHOW_ADS
  ? shuffled.flatMap((photo, i) => {
      const adIdx = AD_POSITIONS.indexOf(i);
      return adIdx !== -1
        ? [{ __ad: true as const, promo: AD_PROMOS[adIdx] }, photo]
        : [photo];
    })
  : shuffled;

const col1 = withAds.filter((_, i) => i % 2 === 0);
const col2 = withAds.filter((_, i) => i % 2 === 1);
---

<BaseLayout>
  <main>

    <!-- トップバナー（スマホ） -->
    {SHOW_ADS && (
      <div id="ad-mobile-wrap" style="overflow:hidden; height:0; margin-bottom:0;">
        <AdBanner variant="horizontal">
          <Promo variant="offframe" size="horizontal" />
        </AdBanner>
      </div>
    )}

    <!-- トップバナー（PC） -->
    {SHOW_ADS && (
      <div id="ad-pc-wrap" style="overflow:hidden; height:0; margin-bottom:0;">
        <AdBanner variant="horizontal">
          <Promo variant="offframe" size="horizontal" />
        </AdBanner>
      </div>
    )}

    <!-- グリッド：スマホ（flex 2カラム） -->
    <div id="grid-mobile" style="display:none;">
      <div class="col">
        {col1.map((item) =>
          "__ad" in item ? (
            <AdBanner variant="card">
              {item.promo && <Promo variant={item.promo} size="card" />}
            </AdBanner>
          ) : (
            <Card title={item.data.title} />
          )
        )}
      </div>
      <div class="col">
        {col2.map((item) =>
          "__ad" in item ? (
            <AdBanner variant="card">
              {item.promo && <Promo variant={item.promo} size="card" />}
            </AdBanner>
          ) : (
            <Card title={item.data.title} />
          )
        )}
      </div>
    </div>

    <!-- グリッド：PC（columnsマソンリー） -->
    <div id="grid-pc" style="display:none;">
      {withAds.map((item) =>
        "__ad" in item ? (
          <AdBanner variant="card">
            {item.promo && <Promo variant={item.promo} size="card" />}
          </AdBanner>
        ) : (
          <Card title={item.data.title} />
        )
      )}
    </div>

  </main>
</BaseLayout>

<style>
  main {
    padding: 1rem;
    background: #000;
  }

  .col {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  #grid-mobile {
    flex-direction: row;
    gap: 1rem;
    align-items: flex-start;
  }

  #grid-pc > :global(a),
  #grid-pc > :global(.ad-banner) {
    break-inside: avoid;
    margin-bottom: 1rem;
    display: block;
  }

  @media (min-width: 1400px) {
    #grid-pc { columns: 4 !important; }
  }

  @media (min-width: 1600px) {
    #grid-pc { columns: 5 !important; }
  }
</style>

<script is:inline>
  function applyLayout() {
    var isPC = window.innerWidth >= 800;
    var adMobile   = document.getElementById("ad-mobile-wrap");
    var adPC       = document.getElementById("ad-pc-wrap");
    var gridMobile = document.getElementById("grid-mobile");
    var gridPC     = document.getElementById("grid-pc");
    if (!gridMobile || !gridPC) return;

    if (isPC) {
      if (adMobile) { adMobile.style.height = "0"; adMobile.style.marginBottom = "0"; }
      if (adPC)     { adPC.style.height = "auto"; adPC.style.marginBottom = "1rem"; }
      gridMobile.style.display = "none";
      gridPC.style.display = "block";
      gridPC.style.columns = "3";
      gridPC.style.columnGap = "1rem";
    } else {
      if (adMobile) { adMobile.style.height = "auto"; adMobile.style.marginBottom = "1rem"; }
      if (adPC)     { adPC.style.height = "0"; adPC.style.marginBottom = "0"; }
      gridMobile.style.display = "flex";
      gridPC.style.display = "none";
    }
  }

  applyLayout();
  window.addEventListener("resize", applyLayout);
  document.addEventListener("astro:page-load", applyLayout);

  // カードをリロードのたびにランダムシャッフル
  function shuffleGrids() {
    ["grid-mobile", "grid-pc"].forEach(function(gridId) {
      var grid = document.getElementById(gridId);
      if (!grid) return;
      // 広告以外のカード要素を取得
      var items = Array.from(grid.querySelectorAll(":scope > a, :scope > .ad-banner, :scope > .col"));
      // grid-mobileはcolが2つなので中身をシャッフル
      if (gridId === "grid-mobile") {
        var cols = grid.querySelectorAll(".col");
        cols.forEach(function(col) {
          var cards = Array.from(col.children);
          for (var i = cards.length - 1; i > 0; i--) {
            var j = Math.floor(Math.random() * (i + 1));
            col.appendChild(cards[j]);
            cards.splice(j, 1);
          }
        });
      } else {
        // grid-pcは直接シャッフル（広告を固定位置に保ちつつカードだけ入れ替え）
        var cards = items.filter(function(el) { return !el.classList.contains("ad-banner"); });
        var ads = items.filter(function(el) { return el.classList.contains("ad-banner"); });
        // カードをシャッフル
        for (var i = cards.length - 1; i > 0; i--) {
          var j = Math.floor(Math.random() * (i + 1));
          var tmp = cards[i]; cards[i] = cards[j]; cards[j] = tmp;
        }
        // 全アイテムを元の順序で再挿入（広告は元位置、カードはシャッフル済み）
        var cardIdx = 0;
        items.forEach(function(el) {
          if (el.classList.contains("ad-banner")) {
            grid.appendChild(el);
          } else {
            grid.appendChild(cards[cardIdx++]);
          }
        });
      }
    });
  }

  document.addEventListener("astro:page-load", shuffleGrids);
  shuffleGrids();
</script>