---
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";
import Card from "../components/Card.astro";
import AdBanner from "../components/AdBanner.astro";
import Promo from "../components/Promo.astro";

// ============ 広告設定 ============
const SHOW_ADS = true;
const AD_POSITIONS = [5, 8, 11, 14, 18];

// 各位置の告知内容（undefinedは広告枠の空白）
type PromoVariant = "offframe" | "new" | "about";
const AD_PROMOS: (PromoVariant | undefined)[] = [
  "offframe",   // 位置5
  "offframe",        // 位置8
  "offframe",      // 位置11
  "offframe",   // 位置14
  "offframe",    // 位置18 → 空白
];

// ============ データ取得 ============
const photos = await getCollection("photos");
// ビルド時は固定順（クライアントでシャッフル）
const shuffled = photos;

type AdItem = { __ad: true; promo: PromoVariant | undefined };
type Item = typeof shuffled[number] | AdItem;

const withAds: Item[] = SHOW_ADS
  ? shuffled.flatMap((photo, i) => {
      const adIdx = AD_POSITIONS.indexOf(i);
      return adIdx !== -1
        ? [{ __ad: true as const, promo: AD_PROMOS[adIdx] }, photo]
        : [photo];
    })
  : shuffled;

const col1 = withAds.filter((_, i) => i % 2 === 0);
const col2 = withAds.filter((_, i) => i % 2 === 1);
---

<BaseLayout>
  <main>

    <!-- トップバナー（スマホ） -->
    {SHOW_ADS && (
      <div id="ad-mobile-wrap" style="overflow:hidden; height:0; margin-bottom:0;">
        <AdBanner variant="horizontal">
          <Promo variant="offframe" size="horizontal" />
        </AdBanner>
      </div>
    )}

    <!-- トップバナー（PC） -->
    {SHOW_ADS && (
      <div id="ad-pc-wrap" style="overflow:hidden; height:0; margin-bottom:0;">
        <AdBanner variant="horizontal">
          <Promo variant="offframe" size="horizontal" />
        </AdBanner>
      </div>
    )}

    <!-- グリッド：スマホ（flex 2カラム） -->
    <div id="grid-mobile" style="display:none;">
      <div class="col">
        {col1.map((item) =>
          "__ad" in item ? (
            <AdBanner variant="card">
              {item.promo && <Promo variant={item.promo} size="card" />}
            </AdBanner>
          ) : (
            <Card title={item.data.title} />
          )
        )}
      </div>
      <div class="col">
        {col2.map((item) =>
          "__ad" in item ? (
            <AdBanner variant="card">
              {item.promo && <Promo variant={item.promo} size="card" />}
            </AdBanner>
          ) : (
            <Card title={item.data.title} />
          )
        )}
      </div>
    </div>

    <!-- グリッド：PC（columnsマソンリー） -->
    <div id="grid-pc" style="display:none;">
      {withAds.map((item) =>
        "__ad" in item ? (
          <AdBanner variant="card">
            {item.promo && <Promo variant={item.promo} size="card" />}
          </AdBanner>
        ) : (
          <Card title={item.data.title} />
        )
      )}
    </div>

  </main>
</BaseLayout>

<style>
  main {
    padding: 1rem;
    background: #000;
  }

  .col {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  #grid-mobile {
    flex-direction: row;
    gap: 1rem;
    align-items: flex-start;
  }

  #grid-pc > :global(a),
  #grid-pc > :global(.ad-banner) {
    break-inside: avoid;
    margin-bottom: 1rem;
    display: block;
  }

  @media (min-width: 1400px) {
    #grid-pc { columns: 4 !important; }
  }

  @media (min-width: 1600px) {
    #grid-pc { columns: 5 !important; }
  }
</style>

<script is:inline>
  function applyLayout() {
    var isPC = window.innerWidth >= 800;
    var adMobile   = document.getElementById("ad-mobile-wrap");
    var adPC       = document.getElementById("ad-pc-wrap");
    var gridMobile = document.getElementById("grid-mobile");
    var gridPC     = document.getElementById("grid-pc");
    if (!gridMobile || !gridPC) return;

    if (isPC) {
      if (adMobile) { adMobile.style.height = "0"; adMobile.style.marginBottom = "0"; }
      if (adPC)     { adPC.style.height = "auto"; adPC.style.marginBottom = "1rem"; }
      gridMobile.style.display = "none";
      gridPC.style.display = "block";
      gridPC.style.columns = "3";
      gridPC.style.columnGap = "1rem";
    } else {
      if (adMobile) { adMobile.style.height = "auto"; adMobile.style.marginBottom = "1rem"; }
      if (adPC)     { adPC.style.height = "0"; adPC.style.marginBottom = "0"; }
      gridMobile.style.display = "flex";
      gridPC.style.display = "none";
    }
  }

  applyLayout();
  window.addEventListener("resize", applyLayout);
  document.addEventListener("astro:page-load", applyLayout);

  // Fisher-Yatesシャッフル
  function shuffle(arr) {
    for (var i = arr.length - 1; i > 0; i--) {
      var j = Math.floor(Math.random() * (i + 1));
      var tmp = arr[i]; arr[i] = arr[j]; arr[j] = tmp;
    }
    return arr;
  }

  // 無料会員ならStandard先、それ以外はランダム
  function sortCards(cards) {
    var isPremium = localStorage.getItem("offframe_premium") === "1";
    if (isPremium) {
      return shuffle(cards);
    }
    // 無料会員: Standard → Premium（各グループ内はシャッフル）
    var std = cards.filter(function(el) { return el.querySelector("img[data-tier='standard']"); });
    var prm = cards.filter(function(el) { return !el.querySelector("img[data-tier='standard']"); });
    return shuffle(std).concat(shuffle(prm));
  }

  // PCカラム数を取得
  function getColCount() {
    var w = window.innerWidth;
    if (w >= 1600) return 5;
    if (w >= 1400) return 4;
    return 3;
  }

  // CSS columnsは上→下に流れるので、行優先の並びを列優先に変換
  // 入力: [row0col0, row0col1, row0col2, row1col0, ...]
  // 出力: [col0row0, col0row1, ..., col1row0, col1row1, ...]
  function transposeForColumns(arr, cols) {
    var n = arr.length;
    if (cols <= 1 || n <= cols) return arr;
    var rows = Math.ceil(n / cols);
    var result = [];
    for (var c = 0; c < cols; c++) {
      for (var r = 0; r < rows; r++) {
        var srcIdx = r * cols + c;
        if (srcIdx < n) {
          result.push(arr[srcIdx]);
        }
      }
    }
    return result;
  }

  // カードをリロードのたびにシャッフル
  function shuffleGrids() {
    ["grid-mobile", "grid-pc"].forEach(function(gridId) {
      var grid = document.getElementById(gridId);
      if (!grid) return;
      var items = Array.from(grid.querySelectorAll(":scope > a, :scope > .ad-banner, :scope > .col"));
      if (gridId === "grid-mobile") {
        var cols = grid.querySelectorAll(".col");
        cols.forEach(function(col) {
          var cards = sortCards(Array.from(col.children));
          cards.forEach(function(card) { col.appendChild(card); });
        });
      } else {
        var cards = items.filter(function(el) { return !el.classList.contains("ad-banner"); });
        cards = sortCards(cards);
        // 無料会員: 各カラムの上部にStandardが来るよう並び替え
        var isPremium = localStorage.getItem("offframe_premium") === "1";
        if (!isPremium) {
          cards = transposeForColumns(cards, getColCount());
        }
        var cardIdx = 0;
        items.forEach(function(el) {
          if (el.classList.contains("ad-banner")) {
            grid.appendChild(el);
          } else {
            grid.appendChild(cards[cardIdx++]);
          }
        });
      }
    });
  }

  document.addEventListener("astro:page-load", shuffleGrids);
  shuffleGrids();
</script>