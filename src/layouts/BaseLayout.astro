---
import SideNav from "../components/SideNav.astro";
import SideNavContent from "../components/SideNavContent.astro";
import MobileNav from "../components/MobileNav.astro";
import Footer from "../components/Footer.astro";
import { ViewTransitions } from "astro:transitions";
import PromoOverlay from "../components/PromoOverlay.astro";
import AuthModal from "../components/AuthModal.astro";
import PremiumModal from "../components/PremiumModal.astro";

interface Props {
  title?: string;
}

const { title = "OffFrame" } = Astro.props;
---

<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    <meta name="google-adsense-account" content="ca-pub-5176750984152342" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/favicon-512.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <ViewTransitions />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&family=Shippori+Mincho:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <style is:global>
      .ad-pc-wrap { display: none; }
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="header-top">
        <a href="/" class="header-logo">
          <span class="header-logo-main">OFF FRAME</span>
          <span class="header-logo-sub">素の、その時間。</span>
        </a>
        <button
          class="burger"
          id="burgerBtn"
          aria-label="メニュー"
          onclick="
            document.getElementById('drawer').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('open');
            this.classList.toggle('open');
          "
        >
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
      <div class="nav-area">
        <MobileNav />
      </div>
    </header>

    <div class="drawer" id="drawer">
      <SideNavContent />
    </div>
    <div
      class="overlay"
      id="overlay"
      onclick="
        document.getElementById('drawer').classList.remove('open');
        document.getElementById('overlay').classList.remove('open');
        document.getElementById('burgerBtn').classList.remove('open');
      "
    ></div>

    <div class="root">
      <div class="left">
        <SideNav />
      </div>
      <div class="right">
        <slot />
        <Footer />
      </div>
    </div>
    <PromoOverlay />
    <AuthModal />
    <PremiumModal />


    <!-- ゲスト向け下部バナー -->
    <div class="bottom-banner" id="bottomBanner">
      <p class="bottom-banner-text">写真の外側が見える、オフフレームモードをログインして体験する</p>
      <button class="bottom-banner-btn" id="bottomBannerBtn">今すぐ体験</button>
      <button class="bottom-banner-close" id="bottomBannerClose">×</button>
    </div>

    <!-- 無料会員向け下部バナー -->
    <div class="bottom-banner-premium" id="bottomBannerPremium">
      <span class="bbp-catch">全画像に、フルアクセス</span>
      <span class="bbp-heading">OFF FRAME Premium</span>
      <span class="bbp-price"><span class="bbp-amount">¥500</span><span class="bbp-period">/ 月（税込）</span></span>
      <button class="bbp-cta" id="bottomBannerPremiumBtn"><span class="bbp-cta-full">プレミアムに登録する</span><span class="bbp-cta-short">プレミアムに登録</span></button>
      <button class="bbp-close" id="bottomBannerPremiumClose">×</button>
    </div>

    <script is:inline>
      function initBottomBanner() {
        var banner = document.getElementById("bottomBanner");
        var premBanner = document.getElementById("bottomBannerPremium");
        var sbKey = Object.keys(localStorage).find(function(k) { return k.startsWith("sb-") && k.endsWith("-auth-token"); });
        var isLoggedIn = sbKey ? !!localStorage.getItem(sbKey) : false;
        var isPremium = localStorage.getItem("offframe_premium") === "1";

        // ゲスト向けバナー
        if (banner) {
          if (isLoggedIn || sessionStorage.getItem("banner_closed") === "1") {
            banner.classList.remove("show");
          } else {
            banner.classList.add("show");
          }

          document.getElementById("bottomBannerBtn").onclick = function() {
            window.openPromoOverlay?.();
          };
          document.getElementById("bottomBannerClose").onclick = function() {
            banner.classList.remove("show");
            sessionStorage.setItem("banner_closed", "1");
            updateBannerPadding();
          };
        }

        // 無料会員向けバナー
        if (premBanner) {
          if (isLoggedIn && !isPremium && sessionStorage.getItem("prem_banner_closed") !== "1") {
            premBanner.classList.add("show");
          } else {
            premBanner.classList.remove("show");
          }

          document.getElementById("bottomBannerPremiumBtn").onclick = function() {
            window.openPremiumModal?.();
          };
          document.getElementById("bottomBannerPremiumClose").onclick = function() {
            premBanner.classList.remove("show");
            sessionStorage.setItem("prem_banner_closed", "1");
            updateBannerPadding();
          };
        }
      }

      function updateBannerPadding() {
        var guestBanner = document.getElementById("bottomBanner");
        var premBanner = document.getElementById("bottomBannerPremium");
        var h = 0;
        if (guestBanner && guestBanner.classList.contains("show")) h = guestBanner.offsetHeight;
        if (premBanner && premBanner.classList.contains("show")) h = Math.max(h, premBanner.offsetHeight);
        var px = h ? (h + "px") : "";
        document.body.style.paddingBottom = px;
        var left = document.querySelector(".left");
        if (left) left.style.paddingBottom = px;
      }

      document.addEventListener("astro:page-load", function() {
        initBottomBanner();
        updateBannerPadding();
      });
      initBottomBanner();
      updateBannerPadding();

      // ログイン後にゲストバナーを消し、無料会員バナーを表示
      document.addEventListener("offframe:loggedin", function() {
        var banner = document.getElementById("bottomBanner");
        if (banner) banner.classList.remove("show");
        var premBanner = document.getElementById("bottomBannerPremium");
        if (premBanner && localStorage.getItem("offframe_premium") !== "1" && sessionStorage.getItem("prem_banner_closed") !== "1") {
          premBanner.classList.add("show");
        }
        updateBannerPadding();
      });

      // プレミアム決済後にバナーを消す
      document.addEventListener("offframe:premium", function() {
        var premBanner = document.getElementById("bottomBannerPremium");
        if (premBanner) premBanner.classList.remove("show");
        updateBannerPadding();
      });
    </script>

    <!-- 初回吹き出し -->
    <div class="tip-bubble" id="tipBubble">
      このボタンを押すと<br>オフフレームモードに<br>切り替わります
    </div>
    <script is:inline>
      // 吹き出し表示タイミング:
      // 1. 初回セッション (tip_phase なし)
      // 2. ログイン後 (offframe:loggedin イベント)
      // 3. プレミアム決済後 (offframe:premium イベント)

      function showTipBubble() {
        var bubble = document.getElementById("tipBubble");
        if (!bubble) return;

        // 現在のフェーズで既に消されていたら表示しない
        var phase = sessionStorage.getItem("tip_phase") || "0";
        var dismissed = sessionStorage.getItem("tip_dismissed");
        if (dismissed === phase) return;

        var isMobile = window.innerWidth <= 1024;

        if (isMobile) {
          var burger = document.getElementById("burgerBtn");
          if (!burger) return;
          var rect = burger.getBoundingClientRect();
          bubble.innerHTML = "メニュー内のボタンを押すと<br>オフフレームモードに切り替わります";
          bubble.className = "tip-bubble tip-sp";
          bubble.style.top = (rect.bottom + 8) + "px";
          bubble.style.right = "1rem";
          bubble.style.left = "auto";
        } else {
          var stdBtn = document.getElementById("offframeBtn");
          var premBtn = document.getElementById("sidenavPremiumBtn");
          if (!stdBtn && !premBtn) return;
          var sbKey2 = Object.keys(localStorage).find(function(k) { return k.startsWith("sb-") && k.endsWith("-auth-token"); });
          var isLoggedIn2 = sbKey2 ? !!localStorage.getItem(sbKey2) : false;
          var isPremium = localStorage.getItem("offframe_premium") === "1";
          bubble.className = "tip-bubble tip-pc";
          if (!isLoggedIn2) {
            // 未ログイン: 二つのボタンの中央
            var r1 = stdBtn ? stdBtn.getBoundingClientRect() : premBtn.getBoundingClientRect();
            var r2 = premBtn ? premBtn.getBoundingClientRect() : r1;
            var midTop = (r1.top + r1.height / 2 + r2.top + r2.height / 2) / 2 - 38;
            bubble.style.top = midTop + "px";
            bubble.style.left = ((r1.right > r2.right ? r1.right : r2.right) + 12) + "px";
          } else if (isPremium) {
            // プレミアム会員: Premiumボタンの横
            var rect = (premBtn || stdBtn).getBoundingClientRect();
            bubble.style.top = (rect.top + rect.height / 2 - 37) + "px";
            bubble.style.left = (rect.right + 12) + "px";
          } else {
            // 無料会員: Standardボタンの横
            var rect = (stdBtn || premBtn).getBoundingClientRect();
            bubble.style.top = (rect.top + rect.height / 2 - 38) + "px";
            bubble.style.left = (rect.right + 12) + "px";
          }
        }

        bubble.style.display = "block";
        bubble.classList.remove("tip-hide");

        function hideBubble() {
          if (bubble.style.display === "none") return;
          bubble.classList.add("tip-hide");
          var currentPhase = sessionStorage.getItem("tip_phase") || "0";
          sessionStorage.setItem("tip_dismissed", currentPhase);
          setTimeout(function() { bubble.style.display = "none"; }, 400);
        }

        bubble.addEventListener("click", hideBubble);

        var burger = document.getElementById("burgerBtn");
        if (burger) {
          burger.addEventListener("click", hideBubble);
        }

        ["offframeBtn", "sidenavPremiumBtn", "overlayRegisterBtn"].forEach(function(id) {
          var btn = document.getElementById(id);
          if (btn) btn.addEventListener("click", hideBubble);
        });
      }

      // ログイン後にドロワーを閉じて吹き出しを再表示
      document.addEventListener("offframe:loggedin", function() {
        var drawer = document.getElementById("drawer");
        var overlay = document.getElementById("overlay");
        var burger = document.getElementById("burgerBtn");
        if (drawer) drawer.classList.remove("open");
        if (overlay) overlay.classList.remove("open");
        if (burger) burger.classList.remove("open");
        sessionStorage.setItem("tip_phase", "1");
        setTimeout(showTipBubble, 1000);
      });

      // プレミアム決済後に吹き出しを再表示
      document.addEventListener("offframe:premium", function() {
        sessionStorage.setItem("tip_phase", "2");
        sessionStorage.removeItem("tip_dismissed");
        setTimeout(showTipBubble, 300);
      });

      document.addEventListener("astro:page-load", function() {
        setTimeout(showTipBubble, 1000);
      });
      setTimeout(showTipBubble, 1000);
    </script>

    <!-- Premium状態同期 -->
    <script is:inline>
      var SUPABASE_FUNCTIONS_URL = "https://gupwbkyehfyrymybrhee.supabase.co/functions/v1";

      window.syncPremiumStatus = async function() {
        try {
          var sbKey = Object.keys(localStorage).find(function(k) {
            return k.startsWith("sb-") && k.endsWith("-auth-token");
          });
          if (!sbKey) return;
          var tokenData = JSON.parse(localStorage.getItem(sbKey) || "{}");
          var accessToken = tokenData.access_token;
          if (!accessToken) return;

          var res = await fetch(SUPABASE_FUNCTIONS_URL + "/get-subscription-status", {
            headers: {
              "Authorization": "Bearer " + accessToken,
              "Content-Type": "application/json"
            }
          });
          var data = await res.json();
          if (data.is_premium) {
            localStorage.setItem("offframe_premium", "1");
          } else {
            localStorage.removeItem("offframe_premium");
          }
          // サブスク情報を保存
          if (data.current_period_end) {
            localStorage.setItem("offframe_period_end", data.current_period_end);
          } else {
            localStorage.removeItem("offframe_period_end");
          }
          if (data.cancel_at_period_end) {
            localStorage.setItem("offframe_cancel_at", "1");
          } else {
            localStorage.removeItem("offframe_cancel_at");
          }
        } catch (e) {
          console.error("syncPremiumStatus error:", e);
        }
      };

      // ページ読み込み時に自動同期
      function autoSyncPremium() {
        if (sessionStorage.getItem("just_logged_out") === "1") {
          sessionStorage.removeItem("just_logged_out");
          return;
        }
        var sbKey = Object.keys(localStorage).find(function(k) {
          return k.startsWith("sb-") && k.endsWith("-auth-token");
        });
        if (sbKey && localStorage.getItem(sbKey)) {
          window.syncPremiumStatus();
        }
      }

      // Checkout成功でTOPに戻ってきた場合
      async function handleCheckoutSuccess() {
        var params = new URLSearchParams(location.search);
        if (params.get("checkout") === "success") {
          if (window.syncPremiumStatus) {
            await window.syncPremiumStatus();
          }
          history.replaceState({}, "", "/");
          sessionStorage.setItem("show_premium_welcome", "1");
          location.reload();
        }
      }

      document.addEventListener("astro:page-load", autoSyncPremium);
      autoSyncPremium();
      handleCheckoutSuccess();
    </script>
  </body>
</html>

<style is:global>
  *, *::before, *::after {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    background: #000;
    color: #000;
    font-family: "Shippori Mincho", "Cormorant Garamond", serif;
  }

  h1, h2, h3, time {
    font-family: "Cormorant Garamond", "Shippori Mincho", serif;
    font-weight: 300;
    color: #000;
  }

  /* ============ OffFrame 画像切替ブラー ============ */
  img.switchable {
    transition: opacity 0.3s ease;
  }

  img.switchable.blurring {
    opacity: 0;
  }

  /* ============ ヘッダー ============ */
  .site-header {
    position: fixed;
    top: 0;
    left: 160px;
    right: 0;
    height: 56px;
    background: #000;
    border-bottom: 1px solid #222;
    display: flex;
    align-items: center;
    z-index: 200;
  }

  .header-top {
    display: none;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid #222;
    padding: 0 1rem;
  }

  .header-logo {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
    padding: 0.8rem 0;
    text-decoration: none;
  }

  .header-logo-main {
    font-family: "Cormorant Garamond", serif;
    font-weight: 300;
    font-size: 1.6rem;
    letter-spacing: 0.25em;
    color: #fff;
  }

  .header-logo-sub {
    font-family: "Shippori Mincho", serif;
    font-weight: 400;
    font-size: 0.9rem;
    letter-spacing: 0.3em;
    color: #fff;
    opacity: 0.7;
  }

  .nav-area {
    flex: 1;
    overflow: hidden;
    min-width: 0;
  }

  /* ============ バーガー ============ */
  .burger {
    display: none;
    flex-direction: column;
    justify-content: center;
    gap: 5px;
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 0.5rem;
    flex-shrink: 0;
    touch-action: manipulation;
  }

  .burger span {
    display: block;
    width: 22px;
    height: 1px;
    background: #fff;
    transition: all 0.3s ease;
  }

  .burger.open span:nth-child(1) { transform: translateY(6px) rotate(45deg); }
  .burger.open span:nth-child(2) { opacity: 0; }
  .burger.open span:nth-child(3) { transform: translateY(-6px) rotate(-45deg); }

  /* ============ ドロワー ============ */
  .drawer {
    position: fixed;
    top: 0;
    right: 0;
    width: 48vw;
    height: 100dvh;
    background: #000;
    border-left: 1px solid #222;
    z-index: 300;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    overflow-y: auto;
  }

  .drawer.open { transform: translateX(0); }

  .overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 299;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
  }

  .overlay.open {
    opacity: 1;
    pointer-events: all;
  }

  /* ============ PC：サイドナビ ============ */
  .left {
    width: 160px;
    flex-shrink: 0;
    border-right: 1px solid #222;
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
    z-index: 199;
  }

  /* ============ コンテンツ ============ */
  .root {
    display: flex;
    min-height: 100vh;
  }

  .right {
    margin-left: 160px;
    margin-top: 56px;
    flex: 1;
    display: flex;
    flex-direction: column;
    max-width: calc(2000px - 160px);
    background: #000;
  }

  /* ============ フェード遷移 ============ */
  @keyframes fadeIn {
    from { opacity: 0; }
    to   { opacity: 1; }
  }

  @keyframes fadeOut {
    from { opacity: 1; }
    to   { opacity: 0; }
  }

  ::view-transition-old(root) { animation: fadeOut 0.3s ease forwards; }
  ::view-transition-new(root) { animation: fadeIn 0.3s ease forwards; }

  /* ============ スマホ ============ */
  @media (max-width: 1024px) {
    .left { display: none; }

    .site-header {
      left: 0;
      height: auto;
      flex-direction: column;
      align-items: stretch;
    }

    .header-top { display: flex; }
    .burger { display: flex; }

    .right {
      margin-left: 0;
      margin-top: 130px;
      max-width: 100%;
    }
  }

  /* ============ 初回吹き出し ============ */
  .tip-bubble {
    display: none;
    position: fixed;
    z-index: 10001;
    background: #fff;
    color: #000;
    font-family: "Shippori Mincho", serif;
    font-size: 0.7rem;
    line-height: 1.7;
    letter-spacing: 0.05em;
    padding: 0.6rem 1rem;
    border-radius: 6px;
    white-space: nowrap;
    box-shadow: 0 2px 12px rgba(0,0,0,0.3);
    animation: tipFadeIn 0.4s ease forwards;
  }

  .tip-bubble::after {
    content: "";
    position: absolute;
    border: 6px solid transparent;
  }

  /* PC: サイドナビ右横 → 左に三角 */
  .tip-bubble.tip-pc::after {
    top: 50%;
    left: -12px;
    transform: translateY(-50%);
    border-right-color: #fff;
  }

  /* スマホ: ハンバーガー下 → 上に三角 */
  .tip-bubble.tip-sp::after {
    top: -12px;
    right: 1rem;
    border-bottom-color: #fff;
  }

  @keyframes tipFadeIn {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes tipFadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
  }

  .tip-bubble.tip-hide {
    animation: tipFadeOut 0.4s ease forwards;
  }

  /* ============ ゲスト向け下部バナー ============ */
  .bottom-banner {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 9998;
    background: #dbc06c;
    border-top: 0.5px solid #b8a050;
    padding: 0.7rem 1.2rem;
    align-items: center;
    justify-content: center;
    gap: 1rem;
  }

  .bottom-banner.show {
    display: flex;
  }

  .bottom-banner-text {
    font-family: "Shippori Mincho", serif;
    font-size: 0.8rem;
    letter-spacing: 0.08em;
    color: #000;
    margin: 0;
    white-space: nowrap;
  }

  .bottom-banner-btn {
    background: #000;
    color: #fff;
    border: none;
    padding: 0.45rem 1.2rem;
    font-family: "Cormorant Garamond", serif;
    font-weight: 300;
    font-size: 0.8rem;
    letter-spacing: 0.15em;
    cursor: pointer;
    white-space: nowrap;
    transition: opacity 0.2s;
    flex-shrink: 0;
  }

  .bottom-banner-btn:hover { opacity: 0.75; }

  .bottom-banner-close {
    background: transparent;
    border: none;
    font-size: 1.2rem;
    color: #000;
    opacity: 0.5;
    cursor: pointer;
    padding: 0 0.3rem;
    line-height: 1;
    flex-shrink: 0;
    transition: opacity 0.2s;
  }

  .bottom-banner-close:hover { opacity: 1; }

  @media (max-width: 1024px) {
    .bottom-banner {
      padding: 0.6rem 0.8rem;
      gap: 0.6rem;
    }

    .bottom-banner-text {
      font-size: 0.65rem;
      white-space: normal;
      line-height: 1.6;
      flex: 1;
    }

    .bottom-banner-btn {
      font-size: 0.7rem;
      padding: 0.4rem 0.8rem;
    }
  }

  /* ============ 無料会員向け下部バナー ============ */
  .bottom-banner-premium {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 9998;
    background: #000;
    border-top: 1px solid #333;
    padding: 0.7rem 1.2rem;
    align-items: center;
    justify-content: center;
    gap: 1.2rem;
  }

  .bottom-banner-premium.show {
    display: flex;
  }

  .bbp-catch {
    font-family: "Shippori Mincho", serif;
    font-size: 0.8rem;
    letter-spacing: 0.08em;
    color: #fff;
    white-space: nowrap;
  }

  .bbp-heading {
    font-family: "Cormorant Garamond", serif;
    font-weight: 300;
    font-size: 0.9rem;
    letter-spacing: 0.2em;
    color: #fff;
    opacity: 0.8;
    white-space: nowrap;
  }

  .bbp-price {
    display: inline-flex;
    align-items: baseline;
    gap: 0.15rem;
    white-space: nowrap;
  }

  .bbp-amount {
    font-family: "Cormorant Garamond", serif;
    font-weight: 300;
    font-size: 1.3rem;
    letter-spacing: 0.05em;
    color: #fff;
  }

  .bbp-period {
    font-family: "Shippori Mincho", serif;
    font-size: 0.65rem;
    color: #fff;
    opacity: 0.6;
  }

  .bbp-cta {
    background: #dbc06c;
    color: #000;
    border: none;
    padding: 0.45rem 1.2rem;
    font-family: "Cormorant Garamond", serif;
    font-weight: 300;
    font-size: 0.8rem;
    letter-spacing: 0.15em;
    cursor: pointer;
    white-space: nowrap;
    transition: opacity 0.2s;
    flex-shrink: 0;
  }

  .bbp-cta:hover { opacity: 0.75; }
  .bbp-cta-short { display: none; }

  .bbp-close {
    background: transparent;
    border: none;
    font-size: 1.2rem;
    color: #fff;
    opacity: 0.4;
    cursor: pointer;
    padding: 0 0.3rem;
    line-height: 1;
    flex-shrink: 0;
    transition: opacity 0.2s;
  }

  .bbp-close:hover { opacity: 1; }

  /* タブレット：全要素を小さめに表示 */
  @media (max-width: 1024px) {
    .bottom-banner-premium {
      padding: 0.6rem 0.8rem;
      gap: 0.5rem;
    }

    .bbp-catch {
      font-size: 0.6rem;
    }

    .bbp-heading {
      font-size: 0.7rem;
      letter-spacing: 0.12em;
    }

    .bbp-amount {
      font-size: 1rem;
    }

    .bbp-period {
      font-size: 0.55rem;
    }

    .bbp-cta {
      font-size: 0.7rem;
      padding: 0.4rem 0.8rem;
    }
  }

  /* スマホ：catch + price + CTA のみ */
  @media (max-width: 600px) {
    .bottom-banner-premium {
      gap: 0.5rem;
      padding: 0.8rem 0.8rem;
    }

    .bbp-catch {
      font-size: 0.65rem;
      letter-spacing: 0.04em;
    }

    .bbp-heading {
      display: none;
    }

    .bbp-amount {
      font-size: 0.95rem;
    }

    .bbp-period {
      font-size: 0.5rem;
    }

    .bbp-cta {
      font-size: 0.5rem;
      padding: 0.3rem 0.5rem;
      letter-spacing: 0.08em;
    }

    .bbp-cta-full { display: none; }
    .bbp-cta-short { display: inline; }
  }
</style>